import * as tslib_1 from "tslib";
import { RegexValidator } from "../util/regex-validator";
import { ObjectMaker } from "../util/object-maker";
import { getConfigObject } from "../util/config-provider";
import { AnnotationTypes } from "../core/validator.static";
import { FormProvider } from '../util/form-provider';
import { checkLength } from '../util/check-length';
import { calculate } from '../algorithm/luhn-algorithm';
export function creditCardValidator(configModel) {
    var cardDigits = {
        AmericanExpress: [15],
        DinersClub: [14, 16, 19],
        Discover: [16, 19],
        JCB: [16, 19],
        Maestro: [12, 16, 19],
        MasterCard: [16],
        Visa: [13, 16, 19]
    };
    function validate(creditCardNumber) {
        var digit = parseInt(creditCardNumber.substring(creditCardNumber.length - 1, creditCardNumber.length));
        return calculate(creditCardNumber.substring(0, creditCardNumber.length - 1)) == parseInt(String(digit)) ? !0 : !1;
    }
    function getCardProviderName(cardNumber) {
        var cardProviderName = "";
        return /^(5018|5020|5038|5612|5893|6304|6759|6761|6762|6763|0604|6390)\d+$/.test(cardNumber) ? cardProviderName = "Maestro" : /^5[1-5]/.test(cardNumber) ? cardProviderName = "MasterCard" : /^4/.test(cardNumber) ? cardProviderName = "Visa" : /^3[47]/.test(cardNumber) ? cardProviderName = "AmericanExpress" : /^(?:2131|1800|35)/.test(cardNumber) ? cardProviderName = "JCB" : /^3(?:0[0-5]|[68])/.test(cardNumber) ? cardProviderName = "DinersClub" : /^6(?:011|5)/.test(cardNumber) && (cardProviderName = "Discover"), cardProviderName;
    }
    return function (control) {
        var e_1, _a;
        var controlValue = control.value;
        var config = getConfigObject(configModel, control);
        var parentObject = (control.parent) ? control.parent.value : undefined;
        if (FormProvider.ProcessRule(control, config)) {
            if (RegexValidator.isNotBlank(controlValue)) {
                var isValid = false;
                var cardTypes = config.fieldName && parentObject[config.fieldName] ? [parentObject[config.fieldName]] : config.creditCardTypes;
                var cardType = '';
                try {
                    for (var cardTypes_1 = tslib_1.__values(cardTypes), cardTypes_1_1 = cardTypes_1.next(); !cardTypes_1_1.done; cardTypes_1_1 = cardTypes_1.next()) {
                        var creditCardType = cardTypes_1_1.value;
                        isValid = checkLength(controlValue.length, cardDigits[creditCardType]) && getCardProviderName(controlValue) == creditCardType && validate(controlValue);
                        cardType = creditCardType;
                        if (isValid)
                            break;
                    }
                }
                catch (e_1_1) { e_1 = { error: e_1_1 }; }
                finally {
                    try {
                        if (cardTypes_1_1 && !cardTypes_1_1.done && (_a = cardTypes_1.return)) _a.call(cardTypes_1);
                    }
                    finally { if (e_1) throw e_1.error; }
                }
                if (!isValid)
                    return ObjectMaker.toJson(AnnotationTypes.creditCard, config, [controlValue, cardType]);
            }
        }
        return ObjectMaker.null();
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlZGl0LWNhcmQudmFsaWRhdG9yLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHJ4d2ViL3JlYWN0aXZlLWZvcm1zLyIsInNvdXJjZXMiOlsicmVhY3RpdmUtZm9ybS12YWxpZGF0b3JzL2NyZWRpdC1jYXJkLnZhbGlkYXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBR0EsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3pELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUVuRCxPQUFPLEVBQUMsZUFBZSxFQUFDLE1BQU0seUJBQXlCLENBQUE7QUFDdkQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQzNELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sc0JBQXNCLENBQUE7QUFDbEQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLDZCQUE2QixDQUFBO0FBRXZELE1BQU0sVUFBVSxtQkFBbUIsQ0FBQyxXQUE2QjtJQUM3RCxJQUFJLFVBQVUsR0FBZ0M7UUFDMUMsZUFBZSxFQUFFLENBQUMsRUFBRSxDQUFDO1FBQ3JCLFVBQVUsRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDO1FBQ3hCLFFBQVEsRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUM7UUFDbEIsR0FBRyxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQztRQUNiLE9BQU8sRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDO1FBQ3JCLFVBQVUsRUFBRSxDQUFDLEVBQUUsQ0FBQztRQUNoQixJQUFJLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQztLQUNyQixDQUFBO0lBQ0QsU0FBUyxRQUFRLENBQUMsZ0JBQXdCO1FBQ3RDLElBQUksS0FBSyxHQUFHLFFBQVEsQ0FBQyxn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TSxDQUFDLGVBQWUsQ0FBQyxVQUFVLEVBQUUsTUFBTSxFQUFFLENBQUMsWUFBWSxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUE7YUFDOUY7U0FDSjtRQUNELE9BQU8sV0FBVyxDQUFDLElBQUksRUFBRSxDQUFDO0lBRTlCLENBQUMsQ0FBQTtBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBYnN0cmFjdENvbnRyb2wgfSBmcm9tIFwiLi4vYWJzdHJhY3QvYWJzdHJhY3QtY29udHJvbFwiXHJcbmltcG9ydCB7IFZhbGlkYXRvckZuIH0gZnJvbSAnLi4vbW9kZWxzL2ludGVyZmFjZS92YWxpZGF0b3ItZm4nXHJcblxyXG5pbXBvcnQgeyBSZWdleFZhbGlkYXRvciB9IGZyb20gXCIuLi91dGlsL3JlZ2V4LXZhbGlkYXRvclwiO1xyXG5pbXBvcnQgeyBPYmplY3RNYWtlciB9IGZyb20gXCIuLi91dGlsL29iamVjdC1tYWtlclwiO1xyXG5pbXBvcnQgeyBDcmVkaXRDYXJkQ29uZmlnIH0gZnJvbSBcIi4uL21vZGVscy9jb25maWcvY3JlZGl0LWNhcmQtY29uZmlnXCI7XHJcbmltcG9ydCB7Z2V0Q29uZmlnT2JqZWN0fSBmcm9tIFwiLi4vdXRpbC9jb25maWctcHJvdmlkZXJcIlxyXG5pbXBvcnQgeyBBbm5vdGF0aW9uVHlwZXMgfSBmcm9tIFwiLi4vY29yZS92YWxpZGF0b3Iuc3RhdGljXCI7XHJcbmltcG9ydCB7IEZvcm1Qcm92aWRlciB9IGZyb20gJy4uL3V0aWwvZm9ybS1wcm92aWRlcic7XHJcbmltcG9ydCB7IGNoZWNrTGVuZ3RoIH0gZnJvbSAnLi4vdXRpbC9jaGVjay1sZW5ndGgnXHJcbmltcG9ydCB7IGNhbGN1bGF0ZSB9IGZyb20gJy4uL2FsZ29yaXRobS9sdWhuLWFsZ29yaXRobSdcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBjcmVkaXRDYXJkVmFsaWRhdG9yKGNvbmZpZ01vZGVsOiBDcmVkaXRDYXJkQ29uZmlnKTogVmFsaWRhdG9yRm4ge1xyXG4gICAgbGV0IGNhcmREaWdpdHM6IHsgW2tleTogc3RyaW5nXTogbnVtYmVyW10gfSA9IHtcclxuICAgICAgICBBbWVyaWNhbkV4cHJlc3M6IFsxNV0sXHJcbiAgICAgICAgRGluZXJzQ2x1YjogWzE0LCAxNiwgMTldLFxyXG4gICAgICAgIERpc2NvdmVyOiBbMTYsIDE5XSxcclxuICAgICAgICBKQ0I6IFsxNiwgMTldLFxyXG4gICAgICAgIE1hZXN0cm86IFsxMiwgMTYsIDE5XSxcclxuICAgICAgICBNYXN0ZXJDYXJkOiBbMTZdLFxyXG4gICAgICAgIFZpc2E6IFsxMywgMTYsIDE5XVxyXG4gICAgfVxyXG4gICAgZnVuY3Rpb24gdmFsaWRhdGUoY3JlZGl0Q2FyZE51bWJlcjogc3RyaW5nKSB7XHJcbiAgICAgICAgdmFyIGRpZ2l0ID0gcGFyc2VJbnQoY3JlZGl0Q2FyZE51bWJlci5zdWJzdHJpbmcoY3JlZGl0Q2FyZE51bWJlci5sZW5ndGggLSAxLCBjcmVkaXRDYXJkTnVtYmVyLmxlbmd0aCkpO1xyXG4gICAgICAgIHJldHVybiBjYWxjdWxhdGUoY3JlZGl0Q2FyZE51bWJlci5zdWJzdHJpbmcoMCwgY3JlZGl0Q2FyZE51bWJlci5sZW5ndGggLSAxKSkgPT0gcGFyc2VJbnQoU3RyaW5nKGRpZ2l0KSkgPyAhMCA6ICExXHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZ2V0Q2FyZFByb3ZpZGVyTmFtZShjYXJkTnVtYmVyOnN0cmluZykge1xyXG4gICAgICAgIHZhciBjYXJkUHJvdmlkZXJOYW1lID0gXCJcIjtcclxuICAgICAgICByZXR1cm4gL14oNTAxOHw1MDIwfDUwMzh8NTYxMnw1ODkzfDYzMDR8Njc1OXw2NzYxfDY3NjJ8Njc2M3wwNjA0fDYzOTApXFxkKyQvLnRlc3QoY2FyZE51bWJlcikgPyBjYXJkUHJvdmlkZXJOYW1lID0gXCJNYWVzdHJvXCIgOiAvXjVbMS01XS8udGVzdChjYXJkTnVtYmVyKSA/IGNhcmRQcm92aWRlck5hbWUgPSBcIk1hc3RlckNhcmRcIiA6IC9eNC8udGVzdChjYXJkTnVtYmVyKSA/IGNhcmRQcm92aWRlck5hbWUgPSBcIlZpc2FcIiA6IC9eM1s0N10vLnRlc3QoY2FyZE51bWJlcikgPyBjYXJkUHJvdmlkZXJOYW1lID0gXCJBbWVyaWNhbkV4cHJlc3NcIiA6IC9eKD86MjEzMXwxODAwfDM1KS8udGVzdChjYXJkTnVtYmVyKSA/IGNhcmRQcm92aWRlck5hbWUgPSBcIkpDQlwiIDogL14zKD86MFswLTVdfFs2OF0pLy50ZXN0KGNhcmROdW1iZXIpID8gY2FyZFByb3ZpZGVyTmFtZSA9IFwiRGluZXJzQ2x1YlwiIDogL142KD86MDExfDUpLy50ZXN0KGNhcmROdW1iZXIpICYmIChjYXJkUHJvdmlkZXJOYW1lID0gXCJEaXNjb3ZlclwiKSwgY2FyZFByb3ZpZGVyTmFtZTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gKGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbCk6IHsgW2tleTogc3RyaW5nXTogYW55IH0gfCBudWxsID0+IHtcclxuICAgICAgICBjb25zdCBjb250cm9sVmFsdWUgPSBjb250cm9sLnZhbHVlO1xyXG4gICAgICAgIGxldCBjb25maWcgPSBnZXRDb25maWdPYmplY3QoY29uZmlnTW9kZWwsY29udHJvbCk7XHJcbiAgICAgICAgY29uc3QgcGFyZW50T2JqZWN0ID0gKGNvbnRyb2wucGFyZW50KSA/IGNvbnRyb2wucGFyZW50LnZhbHVlIDogdW5kZWZpbmVkO1xyXG4gICAgICAgIGlmIChGb3JtUHJvdmlkZXIuUHJvY2Vzc1J1bGUoY29udHJvbCwgY29uZmlnKSkge1xyXG4gICAgICAgICAgICBpZiAoUmVnZXhWYWxpZGF0b3IuaXNOb3RCbGFuayhjb250cm9sVmFsdWUpKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgaXNWYWxpZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgbGV0IGNhcmRUeXBlcyA9IGNvbmZpZy5maWVsZE5hbWUgJiYgcGFyZW50T2JqZWN0W2NvbmZpZy5maWVsZE5hbWVdID8gW3BhcmVudE9iamVjdFtjb25maWcuZmllbGROYW1lXV0gOiBjb25maWcuY3JlZGl0Q2FyZFR5cGVzXHJcbiAgICAgICAgICAgICAgICBsZXQgY2FyZFR5cGU6IHN0cmluZyA9ICcnO1xyXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgY3JlZGl0Q2FyZFR5cGUgb2YgY2FyZFR5cGVzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaXNWYWxpZCA9IGNoZWNrTGVuZ3RoKGNvbnRyb2xWYWx1ZS5sZW5ndGgsIGNhcmREaWdpdHNbY3JlZGl0Q2FyZFR5cGVdKSAmJiBnZXRDYXJkUHJvdmlkZXJOYW1lKGNvbnRyb2xWYWx1ZSkgPT0gY3JlZGl0Q2FyZFR5cGUgJiYgdmFsaWRhdGUoY29udHJvbFZhbHVlKTtcclxuICAgICAgICAgICAgICAgICAgICBjYXJkVHlwZSA9IGNyZWRpdENhcmRUeXBlO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpc1ZhbGlkKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmICghaXNWYWxpZClcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gT2JqZWN0TWFrZXIudG9Kc29uKEFubm90YXRpb25UeXBlcy5jcmVkaXRDYXJkLCBjb25maWcsIFtjb250cm9sVmFsdWUsIGNhcmRUeXBlXSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gT2JqZWN0TWFrZXIubnVsbCgpO1xyXG5cclxuICAgIH1cclxufVxyXG4iXX0=