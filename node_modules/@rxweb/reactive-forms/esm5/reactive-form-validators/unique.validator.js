import * as tslib_1 from "tslib";
import { RegexValidator } from "../util/regex-validator";
import { ObjectMaker } from "../util/object-maker";
import { AnnotationTypes } from "../core/validator.static";
import { FormProvider } from '../util/form-provider';
import { ApplicationUtil } from '../util/app-util';
import { getConfigObject } from "../util/config-provider";
export function uniqueValidator(configModel) {
    var setTimeoutFunc = function (invalidateControls, controlValues) {
        var timeOut = setTimeout(function () {
            invalidateControls.forEach(function (t) {
                var isMatched = controlValues.filter(function (x) { return x == t.value; })[0];
                if (!isMatched)
                    t.updateValueAndValidity();
            });
            clearTimeout(timeOut);
        }, 200);
    };
    var additionalValidation = function (config, fieldName, formGroup, formArray, currentValue) {
        var indexOf = formArray.controls.indexOf(formGroup);
        var formArrayValue = [];
        if (indexOf != -1) {
            formArray.value.forEach(function (t, i) {
                if (indexOf != i)
                    formArrayValue.push(t);
            });
            return config.additionalValidation(currentValue, indexOf, fieldName, formGroup.value, formArrayValue);
        }
        return false;
    };
    return function (control) {
        var e_1, _a;
        var config = getConfigObject(configModel, control);
        if (FormProvider.ProcessRule(control, config)) {
            if (RegexValidator.isNotBlank(control.value)) {
                var formArray = ApplicationUtil.getParentFormArray(control);
                var parentFormGroup = control.parent ? control.parent : undefined;
                var invalidateControls = [];
                var controlValues = [];
                if (formArray && parentFormGroup) {
                    var currentValue = control.value;
                    var fieldName_1 = ApplicationUtil.getFormControlName(control);
                    var isMatched = false;
                    var _loop_1 = function (formGroup) {
                        if (formGroup != parentFormGroup) {
                            isMatched = (ApplicationUtil.toLower(formGroup.controls[fieldName_1].value) == ApplicationUtil.toLower(currentValue) && !(formGroup.controls[fieldName_1].errors && formGroup.controls[fieldName_1].errors[AnnotationTypes.unique]));
                            if (formGroup.controls[fieldName_1].errors && formGroup.controls[fieldName_1].errors[AnnotationTypes.unique]) {
                                matchedControl = formArray.controls.filter(function (t) { return t.controls[fieldName_1] != formGroup.controls[fieldName_1] && ApplicationUtil.toLower(t.controls[fieldName_1].value) == ApplicationUtil.toLower(formGroup.controls[fieldName_1].value); })[0];
                                if (!matchedControl)
                                    invalidateControls.push(formGroup.controls[fieldName_1]);
                            }
                            else
                                controlValues.push(formGroup.controls[fieldName_1].value);
                        }
                        if (isMatched)
                            return "break";
                    };
                    var matchedControl;
                    try {
                        for (var _b = tslib_1.__values(formArray.controls), _c = _b.next(); !_c.done; _c = _b.next()) {
                            var formGroup = _c.value;
                            var state_1 = _loop_1(formGroup);
                            if (state_1 === "break")
                                break;
                        }
                    }
                    catch (e_1_1) { e_1 = { error: e_1_1 }; }
                    finally {
                        try {
                            if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                        }
                        finally { if (e_1) throw e_1.error; }
                    }
                    if (invalidateControls.length > 0)
                        setTimeoutFunc(invalidateControls, controlValues);
                    var validation = false;
                    if (config.additionalValidation) {
                        validation = additionalValidation(config, fieldName_1, parentFormGroup, formArray, currentValue);
                    }
                    if (isMatched && !validation)
                        return ObjectMaker.toJson(AnnotationTypes.unique, config, [control.value]);
                }
            }
        }
        return ObjectMaker.null();
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidW5pcXVlLnZhbGlkYXRvci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0ByeHdlYi9yZWFjdGl2ZS1mb3Jtcy8iLCJzb3VyY2VzIjpbInJlYWN0aXZlLWZvcm0tdmFsaWRhdG9ycy91bmlxdWUudmFsaWRhdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFHQSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDekQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRW5ELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDckQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ25ELE9BQU8sRUFBQyxlQUFlLEVBQUMsTUFBTSx5QkFBeUIsQ0FBQztBQUN4RCxNQUFNLFVBQVUsZUFBZSxDQUFDLFdBQXlCO0lBQ3JELElBQUksY0FBYyxHQUFHLFVBQUMsa0JBQXFDLEVBQUUsYUFBb0I7UUFDakYsSUFBSSxPQUFPLEdBQUcsVUFBVSxDQUFDO1lBQ3ZCLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxVQUFBLENBQUM7Z0JBQzFCLElBQUksU0FBUyxHQUFHLGFBQWEsQ0FBQyxNQUFNLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBWixDQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtnQkFDMUQsSUFBSSxDQUFDLFNBQVM7b0JBQ1osQ0FBQyxDQUFDLHNCQUFzQixFQUFFLENBQUM7WUFDL0IsQ0FBQyxDQUFDLENBQUE7WUFDRixZQUFZLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDeEIsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFBO0lBQ1QsQ0FBQyxDQUFBO0lBQ0QsSUFBSSxvQkFBb0IsR0FBRyxVQUFDLE1BQVcsRUFBRSxTQUFpQixFQUFFLFNBQTBCLEVB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LFNBQVMsQ0FBQyxRQUFRLENBQUMsV0FBUyxDQUFDLENBQUMsQ0FBQTs2QkFDekQ7O2dDQUVDLGFBQWEsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxXQUFTLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQzt5QkFDM0Q7d0JBQ0QsSUFBSSxTQUFTOzJDQUNMOzt3QkFSQSxjQUFjOzt3QkFKeEIsS0FBc0IsSUFBQSxLQUFBLGlCQUFBLFNBQVMsQ0FBQyxRQUFRLENBQUEsZ0JBQUE7NEJBQW5DLElBQUksU0FBUyxXQUFBO2tEQUFULFNBQVM7Ozt5QkFhakI7Ozs7Ozs7OztvQkFDRCxJQUFJLGtCQUFrQixDQUFDLE1BQU0sR0FBRyxDQUFDO3dCQUMvQixjQUFjLENBQUMsa0JBQWtCLEVBQUUsYUFBYSxDQUFDLENBQUM7b0JBRXBELElBQUksVUFBVSxHQUFHLEtBQUssQ0FBQztvQkFDdkIsSUFBSSxNQUFNLENBQUMsb0JBQW9CLEVBQUU7d0JBQy9CLFVBQVUsR0FBRyxvQkFBb0IsQ0FBQyxNQUFNLEVBQUUsV0FBUyxFQUFFLGVBQWUsRUFBRSxTQUFTLEVBQUUsWUFBWSxDQUFDLENBQUM7cUJBQ2hHO29CQUNELElBQUksU0FBUyxJQUFJLENBQUMsVUFBVTt3QkFDMUIsT0FBTyxXQUFXLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUE7aUJBQzdFO2FBQ0Y7U0FDRjtRQUNELE9BQU8sV0FBVyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQzVCLENBQUMsQ0FBQTtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBYnN0cmFjdENvbnRyb2wgfSBmcm9tIFwiLi4vYWJzdHJhY3QvYWJzdHJhY3QtY29udHJvbFwiXHJcbmltcG9ydCB7IFZhbGlkYXRvckZuIH0gZnJvbSAnLi4vbW9kZWxzL2ludGVyZmFjZS92YWxpZGF0b3ItZm4nXHJcbmltcG9ydCB7IFJ4Rm9ybUFycmF5IH0gZnJvbSBcIi4uL3NlcnZpY2VzL3J4LWZvcm0tYXJyYXlcIlxyXG5pbXBvcnQgeyBSZWdleFZhbGlkYXRvciB9IGZyb20gXCIuLi91dGlsL3JlZ2V4LXZhbGlkYXRvclwiO1xyXG5pbXBvcnQgeyBPYmplY3RNYWtlciB9IGZyb20gXCIuLi91dGlsL29iamVjdC1tYWtlclwiO1xyXG5pbXBvcnQgeyBVbmlxdWVDb25maWcgfSBmcm9tIFwiLi4vbW9kZWxzL2NvbmZpZy91bmlxdWUtY29uZmlnXCI7XHJcbmltcG9ydCB7IEFubm90YXRpb25UeXBlcyB9IGZyb20gXCIuLi9jb3JlL3ZhbGlkYXRvci5zdGF0aWNcIjtcclxuaW1wb3J0IHsgRm9ybVByb3ZpZGVyIH0gZnJvbSAnLi4vdXRpbC9mb3JtLXByb3ZpZGVyJztcclxuaW1wb3J0IHsgQXBwbGljYXRpb25VdGlsIH0gZnJvbSAnLi4vdXRpbC9hcHAtdXRpbCc7XHJcbmltcG9ydCB7Z2V0Q29uZmlnT2JqZWN0fSBmcm9tIFwiLi4vdXRpbC9jb25maWctcHJvdmlkZXJcIjtcclxuZXhwb3J0IGZ1bmN0aW9uIHVuaXF1ZVZhbGlkYXRvcihjb25maWdNb2RlbDogVW5pcXVlQ29uZmlnKTogVmFsaWRhdG9yRm4ge1xyXG4gICAgdmFyIHNldFRpbWVvdXRGdW5jID0gKGludmFsaWRhdGVDb250cm9sczogQWJzdHJhY3RDb250cm9sW10sIGNvbnRyb2xWYWx1ZXM6IGFueVtdKSA9PiB7XHJcbiAgICBsZXQgdGltZU91dCA9IHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICBpbnZhbGlkYXRlQ29udHJvbHMuZm9yRWFjaCh0ID0+IHtcclxuICAgICAgICBsZXQgaXNNYXRjaGVkID0gY29udHJvbFZhbHVlcy5maWx0ZXIoeCA9PiB4ID09IHQudmFsdWUpWzBdXHJcbiAgICAgICAgaWYgKCFpc01hdGNoZWQpXHJcbiAgICAgICAgICB0LnVwZGF0ZVZhbHVlQW5kVmFsaWRpdHkoKTtcclxuICAgICAgfSlcclxuICAgICAgY2xlYXJUaW1lb3V0KHRpbWVPdXQpO1xyXG4gICAgfSwgMjAwKVxyXG4gIH1cclxuICB2YXIgYWRkaXRpb25hbFZhbGlkYXRpb24gPSAoY29uZmlnOiBhbnksIGZpZWxkTmFtZTogc3RyaW5nLCBmb3JtR3JvdXA6IEFic3RyYWN0Q29udHJvbCwgZm9ybUFycmF5OiBSeEZvcm1BcnJheSwgY3VycmVudFZhbHVlOiBhbnkpID0+IHtcclxuICAgIGxldCBpbmRleE9mID0gZm9ybUFycmF5LmNvbnRyb2xzLmluZGV4T2YoZm9ybUdyb3VwKTtcclxuICAgIGxldCBmb3JtQXJyYXlWYWx1ZTphbnlbXSA9IFtdO1xyXG4gICAgaWYgKGluZGV4T2YgIT0gLTEpIHtcclxuICAgICAgZm9ybUFycmF5LnZhbHVlLmZvckVhY2goKHQsIGkpID0+IHtcclxuICAgICAgICBpZiAoaW5kZXhPZiAhPSBpKVxyXG4gICAgICAgICAgZm9ybUFycmF5VmFsdWUucHVzaCh0KVxyXG4gICAgICB9KVxyXG4gICAgICByZXR1cm4gY29uZmlnLmFkZGl0aW9uYWxWYWxpZGF0aW9uKGN1cnJlbnRWYWx1ZSwgaW5kZXhPZiwgZmllbGROYW1lLCBmb3JtR3JvdXAudmFsdWUsIGZvcm1BcnJheVZhbHVlKTtcclxuICAgIH1cclxuICAgIHJldHVybiBmYWxzZTtcclxuXHJcbiAgfVxyXG4gICAgcmV0dXJuIChjb250cm9sOiBBYnN0cmFjdENvbnRyb2wpOiB7IFtrZXk6IHN0cmluZ106IGFueSB9IHwgbnVsbCA9PiB7XHJcbiAgICBsZXQgY29uZmlnID0gZ2V0Q29uZmlnT2JqZWN0KGNvbmZpZ01vZGVsLGNvbnRyb2wpO1xyXG4gICAgaWYgKEZvcm1Qcm92aWRlci5Qcm9jZXNzUnVsZShjb250cm9sLCBjb25maWcpKSB7XHJcbiAgICAgIGlmIChSZWdleFZhbGlkYXRvci5pc05vdEJsYW5rKGNvbnRyb2wudmFsdWUpKSB7XHJcbiAgICAgICAgbGV0IGZvcm1BcnJheSA9IEFwcGxpY2F0aW9uVXRpbC5nZXRQYXJlbnRGb3JtQXJyYXkoY29udHJvbCk7XHJcbiAgICAgICAgbGV0IHBhcmVudEZvcm1Hcm91cCA9IGNvbnRyb2wucGFyZW50ID8gY29udHJvbC5wYXJlbnQgOiB1bmRlZmluZWQ7XHJcbiAgICAgICAgbGV0IGludmFsaWRhdGVDb250cm9sczogQWJzdHJhY3RDb250cm9sW10gPSBbXTtcclxuICAgICAgICBsZXQgY29udHJvbFZhbHVlcyA9IFtdO1xyXG4gICAgICAgIGlmIChmb3JtQXJyYXkgJiYgcGFyZW50Rm9ybUdyb3VwKSB7XHJcbiAgICAgICAgICBsZXQgY3VycmVudFZhbHVlID0gY29udHJvbC52YWx1ZTtcclxuICAgICAgICAgIGxldCBmaWVsZE5hbWUgPSBBcHBsaWNhdGlvblV0aWwuZ2V0Rm9ybUNvbnRyb2xOYW1lKGNvbnRyb2wpO1xyXG4gICAgICAgICAgbGV0IGlzTWF0Y2hlZCA9IGZhbHNlO1xyXG4gICAgICAgICAgZm9yIChsZXQgZm9ybUdyb3VwIG9mIGZvcm1BcnJheS5jb250cm9scykge1xyXG4gICAgICAgICAgICBpZiAoZm9ybUdyb3VwICE9IHBhcmVudEZvcm1Hcm91cCkge1xyXG4gICAgICAgICAgICAgIGlzTWF0Y2hlZCA9IChBcHBsaWNhdGlvblV0aWwudG9Mb3dlcihmb3JtR3JvdXAuY29udHJvbHNbZmllbGROYW1lXS52YWx1ZSkgPT0gQXBwbGljYXRpb25VdGlsLnRvTG93ZXIoY3VycmVudFZhbHVlKSAmJiAhKGZvcm1Hcm91cC5jb250cm9sc1tmaWVsZE5hbWVdLmVycm9ycyAmJiBmb3JtR3JvdXAuY29udHJvbHNbZmllbGROYW1lXS5lcnJvcnNbQW5ub3RhdGlvblR5cGVzLnVuaXF1ZV0pKVxyXG4gICAgICAgICAgICAgIGlmIChmb3JtR3JvdXAuY29udHJvbHNbZmllbGROYW1lXS5lcnJvcnMgJiYgZm9ybUdyb3VwLmNvbnRyb2xzW2ZpZWxkTmFtZV0uZXJyb3JzW0Fubm90YXRpb25UeXBlcy51bmlxdWVdKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgbWF0Y2hlZENvbnRyb2wgPSBmb3JtQXJyYXkuY29udHJvbHMuZmlsdGVyKHQgPT4gdC5jb250cm9sc1tmaWVsZE5hbWVdICE9IGZvcm1Hcm91cC5jb250cm9sc1tmaWVsZE5hbWVdICYmIEFwcGxpY2F0aW9uVXRpbC50b0xvd2VyKHQuY29udHJvbHNbZmllbGROYW1lXS52YWx1ZSkgPT0gQXBwbGljYXRpb25VdGlsLnRvTG93ZXIoZm9ybUdyb3VwLmNvbnRyb2xzW2ZpZWxkTmFtZV0udmFsdWUpKVswXTtcclxuICAgICAgICAgICAgICAgIGlmICghbWF0Y2hlZENvbnRyb2wpXHJcbiAgICAgICAgICAgICAgICAgIGludmFsaWRhdGVDb250cm9scy5wdXNoKGZvcm1Hcm91cC5jb250cm9sc1tmaWVsZE5hbWVdKVxyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICBjb250cm9sVmFsdWVzLnB1c2goZm9ybUdyb3VwLmNvbnRyb2xzW2ZpZWxkTmFtZV0udmFsdWUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChpc01hdGNoZWQpXHJcbiAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBpZiAoaW52YWxpZGF0ZUNvbnRyb2xzLmxlbmd0aCA+IDApXHJcbiAgICAgICAgICAgIHNldFRpbWVvdXRGdW5jKGludmFsaWRhdGVDb250cm9scywgY29udHJvbFZhbHVlcyk7XHJcblxyXG4gICAgICAgICAgbGV0IHZhbGlkYXRpb24gPSBmYWxzZTtcclxuICAgICAgICAgIGlmIChjb25maWcuYWRkaXRpb25hbFZhbGlkYXRpb24pIHtcclxuICAgICAgICAgICAgdmFsaWRhdGlvbiA9IGFkZGl0aW9uYWxWYWxpZGF0aW9uKGNvbmZpZywgZmllbGROYW1lLCBwYXJlbnRGb3JtR3JvdXAsIGZvcm1BcnJheSwgY3VycmVudFZhbHVlKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGlmIChpc01hdGNoZWQgJiYgIXZhbGlkYXRpb24pXHJcbiAgICAgICAgICAgIHJldHVybiBPYmplY3RNYWtlci50b0pzb24oQW5ub3RhdGlvblR5cGVzLnVuaXF1ZSwgY29uZmlnLCBbY29udHJvbC52YWx1ZV0pXHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gT2JqZWN0TWFrZXIubnVsbCgpO1xyXG4gIH1cclxufVxyXG4iXX0=