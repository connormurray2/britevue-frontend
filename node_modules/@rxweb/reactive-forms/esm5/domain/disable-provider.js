import * as tslib_1 from "tslib";
import { defaultContainer } from "../core/defaultContainer";
import { OBJECT_PROPERTY } from "../const/validator.const";
import { ApplicationUtil } from "../util/app-util";
import { RXCODE, MODEL_INSTANCE } from "../const/app.const";
import { instanceProvider } from "../util/instance-provider.function";
var DisableProvider = /** @class */ (function () {
    function DisableProvider(decoratorType, entityObject) {
        this.decoratorType = decoratorType;
        this.entityObject = entityObject;
    }
    DisableProvider.prototype.getFormGroupName = function (currentFormGroup) {
        var e_1, _a;
        var keyName = '';
        if (currentFormGroup.parent)
            try {
                for (var _b = tslib_1.__values(Object.keys(currentFormGroup.parent.controls)), _c = _b.next(); !_c.done; _c = _b.next()) {
                    var controlName = _c.value;
                    if (currentFormGroup.parent.controls[controlName] == currentFormGroup) {
                        keyName = controlName;
                        break;
                    }
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                }
                finally { if (e_1) throw e_1.error; }
            }
        return keyName;
    };
    DisableProvider.prototype.zeroArgumentProcess = function (control, columnName) {
        var disabledColumns = [];
        this.getDisabledColumns(control.parent, "" + columnName + RXCODE + "0", false).forEach(function (t) { return disabledColumns.push(t); });
        var path = this.topControlPath(control, columnName);
        var splitPath = path.split(".");
        if (splitPath.length > 1) {
            var rootFormGroup = ApplicationUtil.getRootFormGroup(control);
            this.getDisabledColumns(rootFormGroup, "" + path + RXCODE + "0", true).forEach(function (t) { return disabledColumns.push(t); });
            var controlPath = '';
            for (var i = 0; i < splitPath.length - 2; i++) {
                var controlName = splitPath[i];
                controlPath = "" + path.replace(controlName + ".", '') + RXCODE + "-0";
                if (rootFormGroup.controls[controlName]) {
                    this.getDisabledColumns(rootFormGroup.controls[controlName], controlPath, true, controlName).forEach(function (t) { return disabledColumns.push(t); });
                    rootFormGroup = rootFormGroup.controls[controlName];
                }
            }
        }
        return disabledColumns;
    };
    DisableProvider.prototype.getDisabledColumns = function (formGroup, columnName, isRoot, pathName) {
        if (pathName === void 0) { pathName = ""; }
        if (formGroup && formGroup[MODEL_INSTANCE]) {
            var instanceContainer = instanceProvider(formGroup[MODEL_INSTANCE].constructor, this.entityObject);
            return this.getChangeDetectionColumns(instanceContainer, columnName, isRoot, pathName);
        }
        return [];
    };
    DisableProvider.prototype.getChangeDetectionColumns = function (instanceContainer, columnName, isRoot, pathName) {
        var _this = this;
        if (pathName === void 0) { pathName = ""; }
        var conditionalDisableControls = [];
        var columns = instanceContainer.nonValidationDecorators[this.decoratorType].changeDetection[columnName];
        if (columns) {
            columns.forEach(function (t) {
                conditionalDisableControls.push({ controlPath: pathName ? pathName + "." + t : t, conditionalExpression: instanceContainer.nonValidationDecorators[_this.decoratorType].conditionalExpressions[t], isRoot: isRoot });
            });
        }
        return conditionalDisableControls;
    };
    DisableProvider.prototype.topControlPath = function (control, columnName) {
        if (control.parent) {
            var name_1 = this.getFormGroupName(control.parent);
            if (name_1) {
                columnName = name_1 + "." + columnName;
                return this.topControlPath(control.parent, columnName);
            }
        }
        return columnName;
    };
    DisableProvider.prototype.childControlDisabledExpression = function (formGroup, columnName, path) {
        var _this = this;
        if (path === void 0) { path = ""; }
        var disabledColumns = [];
        if (formGroup[MODEL_INSTANCE]) {
            var instanceContainer = defaultContainer.get(formGroup[MODEL_INSTANCE].constructor);
            if (instanceContainer && instanceContainer.properties) {
                this.getChangeDetectionColumns(instanceContainer, columnName, true, path).forEach(function (t) { return disabledColumns.push(t); });
                var props = instanceContainer.properties.filter(function (t) { return t.propertyType == OBJECT_PROPERTY; });
                props.forEach(function (t) {
                    if (formGroup.controls[t.name]) {
                        var columns = _this.getDisabledColumns(formGroup.controls[t.name], columnName, true, path ? path + "." + t.name : "" + t.name);
                        columns.forEach(function (x) { return disabledColumns.push(x); });
                        _this.childControlDisabledExpression(formGroup.controls[t.name], columnName, path ? path + "." + t.name : "" + t.name).forEach(function (y) { return disabledColumns.push(y); });
                    }
                });
            }
        }
        return disabledColumns;
    };
    DisableProvider.prototype.oneArgumentProcess = function (control, columnName) {
        var path = this.topControlPath(control, columnName);
        var rootFormGroup = ApplicationUtil.getRootFormGroup(control);
        var childColumns = this.childControlDisabledExpression(rootFormGroup, path);
        return childColumns;
    };
    return DisableProvider;
}());
export { DisableProvider };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlzYWJsZS1wcm92aWRlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0ByeHdlYi9yZWFjdGl2ZS1mb3Jtcy8iLCJzb3VyY2VzIjpbImRvbWFpbi9kaXNhYmxlLXByb3ZpZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUU1RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sMEJBQTBCLENBQUE7QUFDMUQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxNQUFNLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDNUQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sb0NBQW9DLENBQUE7QUFJckU7SUFFSSx5QkFBb0IsYUFBcUIsRUFBVSxZQUFvQztRQUFuRSxrQkFBYSxHQUFiLGFBQWEsQ0FBUTtRQUFVLGlCQUFZLEdBQVosWUFBWSxDQUF3QjtJQUV2RixDQUFDO0lBSUQsMENBQWdCLEdBQWhCLFVBQWlCLGdCQUFpQzs7UUFDOUMsSUFBSSxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBQ2pCLElBQUksZ0JBQWdCLENBQUMsTUFBTTs7Z0JBQ3ZCLEtBQXdCLElBQUEsS0FBQSxpQkFBQSxNQUFNLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQSxnQkFBQTtvQkFBaEUsSUFBSSxXQUFXLFdBQUE7b0JBQ2hCLElBQUksZ0JBQWdCLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsSUFBSSxnQkFBZ0IsRUFBRTt3QkFDbkUsT0FBTyxHQUFHLFdBQVcsQ0FBQzt3QkFDdEIsTUFBTTtxQkFDVDtpQkFBQTs7Ozs7Ozs7YUFBQTtRQUNULE9BQU8sT0FBTyxDQUFDO0lBQ25CLENBQUM7SUFFRCw2Q0FBbUIsR0FBbkIsVUFBb0IsT0FBd0IsRUFBRSxVQUFrQjtRQUM1RCxJQUFJ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QUNMLENBQUMsQ0FBQyxDQUFBO2FBQ0w7U0FDSjtRQUNELE9BQU8sZUFBZSxDQUFDO0lBQzNCLENBQUM7SUFFRCw0Q0FBa0IsR0FBbEIsVUFBbUIsT0FBd0IsRUFBRSxVQUFrQjtRQUMzRCxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxVQUFVLENBQUMsQ0FBQztRQUNwRCxJQUFJLGFBQWEsR0FBRyxlQUFlLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDOUQsSUFBSSxZQUFZLEdBQUcsSUFBSSxDQUFDLDhCQUE4QixDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUM1RSxPQUFPLFlBQVksQ0FBQztJQUN4QixDQUFDO0lBQ0wsc0JBQUM7QUFBRCxDQUFDLEFBOUZELElBOEZDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZGVmYXVsdENvbnRhaW5lciB9IGZyb20gXCIuLi9jb3JlL2RlZmF1bHRDb250YWluZXJcIjtcclxuaW1wb3J0IHsgSW5zdGFuY2VDb250YWluZXIgfSBmcm9tIFwiLi4vY29yZS92YWxpZGF0b3IuaW50ZXJmYWNlXCI7XHJcbmltcG9ydCB7IE9CSkVDVF9QUk9QRVJUWSB9IGZyb20gXCIuLi9jb25zdC92YWxpZGF0b3IuY29uc3RcIlxyXG5pbXBvcnQgeyBBcHBsaWNhdGlvblV0aWwgfSBmcm9tIFwiLi4vdXRpbC9hcHAtdXRpbFwiO1xyXG5pbXBvcnQgeyBSWENPREUsIE1PREVMX0lOU1RBTkNFIH0gZnJvbSBcIi4uL2NvbnN0L2FwcC5jb25zdFwiO1xyXG5pbXBvcnQgeyBpbnN0YW5jZVByb3ZpZGVyIH0gZnJvbSBcIi4uL3V0aWwvaW5zdGFuY2UtcHJvdmlkZXIuZnVuY3Rpb25cIlxyXG5pbXBvcnQgeyBBYnN0cmFjdENvbnRyb2wgfSBmcm9tIFwiLi4vYWJzdHJhY3QvYWJzdHJhY3QtY29udHJvbFwiO1xyXG5pbXBvcnQgeyBJRm9ybUdyb3VwIH0gZnJvbSBcIi4uXCI7XHJcblxyXG5leHBvcnQgY2xhc3MgRGlzYWJsZVByb3ZpZGVyIHtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGRlY29yYXRvclR5cGU6IHN0cmluZywgcHJpdmF0ZSBlbnRpdHlPYmplY3Q6IHsgW2tleTogc3RyaW5nXTogYW55IH0pIHtcclxuXHJcbiAgICB9XHJcblxyXG5cclxuXHJcbiAgICBnZXRGb3JtR3JvdXBOYW1lKGN1cnJlbnRGb3JtR3JvdXA6IElGb3JtR3JvdXA8YW55Pikge1xyXG4gICAgICAgIGxldCBrZXlOYW1lID0gJyc7XHJcbiAgICAgICAgaWYgKGN1cnJlbnRGb3JtR3JvdXAucGFyZW50KVxyXG4gICAgICAgICAgICBmb3IgKHZhciBjb250cm9sTmFtZSBvZiBPYmplY3Qua2V5cyhjdXJyZW50Rm9ybUdyb3VwLnBhcmVudC5jb250cm9scykpXHJcbiAgICAgICAgICAgICAgICBpZiAoY3VycmVudEZvcm1Hcm91cC5wYXJlbnQuY29udHJvbHNbY29udHJvbE5hbWVdID09IGN1cnJlbnRGb3JtR3JvdXApIHtcclxuICAgICAgICAgICAgICAgICAgICBrZXlOYW1lID0gY29udHJvbE5hbWU7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGtleU5hbWU7XHJcbiAgICB9XHJcblxyXG4gICAgemVyb0FyZ3VtZW50UHJvY2Vzcyhjb250cm9sOiBBYnN0cmFjdENvbnRyb2wsIGNvbHVtbk5hbWU6IHN0cmluZykge1xyXG4gICAgICAgIGxldCBkaXNhYmxlZENvbHVtbnM6IGFueVtdID0gW107XHJcbiAgICAgICAgdGhpcy5nZXREaXNhYmxlZENvbHVtbnMoPElGb3JtR3JvdXA8YW55Pj5jb250cm9sLnBhcmVudCwgYCR7Y29sdW1uTmFtZX0ke1JYQ09ERX0wYCwgZmFsc2UpLmZvckVhY2godCA9PiBkaXNhYmxlZENvbHVtbnMucHVzaCh0KSk7XHJcbiAgICAgICAgbGV0IHBhdGggPSB0aGlzLnRvcENvbnRyb2xQYXRoKGNvbnRyb2wsIGNvbHVtbk5hbWUpO1xyXG4gICAgICAgIGxldCBzcGxpdFBhdGggPSBwYXRoLnNwbGl0KFwiLlwiKTtcclxuICAgICAgICBpZiAoc3BsaXRQYXRoLmxlbmd0aCA+IDEpIHtcclxuICAgICAgICAgICAgbGV0IHJvb3RGb3JtR3JvdXAgPSBBcHBsaWNhdGlvblV0aWwuZ2V0Um9vdEZvcm1Hcm91cChjb250cm9sKTtcclxuICAgICAgICAgICAgdGhpcy5nZXREaXNhYmxlZENvbHVtbnMocm9vdEZvcm1Hcm91cCwgYCR7cGF0aH0ke1JYQ09ERX0wYCwgdHJ1ZSkuZm9yRWFjaCh0ID0+IGRpc2FibGVkQ29sdW1ucy5wdXNoKHQpKTtcclxuICAgICAgICAgICAgbGV0IGNvbnRyb2xQYXRoOiBzdHJpbmcgPSAnJztcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzcGxpdFBhdGgubGVuZ3RoIC0gMjsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgY29udHJvbE5hbWUgPSBzcGxpdFBhdGhbaV07XHJcbiAgICAgICAgICAgICAgICBjb250cm9sUGF0aCA9IGAke3BhdGgucmVwbGFjZShgJHtjb250cm9sTmFtZX0uYCwgJycpfSR7UlhDT0RFfS0wYFxyXG4gICAgICAgICAgICAgICAgaWYgKHJvb3RGb3JtR3JvdXAuY29udHJvbHNbY29udHJvbE5hbWVdKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXREaXNhYmxlZENvbHVtbnMoPElGb3JtR3JvdXA8YW55Pj5yb290Rm9ybUdyb3VwLmNvbnRyb2xzW2NvbnRyb2xOYW1lXSwgY29udHJvbFBhdGgsIHRydWUsIGNvbnRyb2xOYW1lKS5mb3JFYWNoKHQgPT4gZGlzYWJsZWRDb2x1bW5zLnB1c2godCkpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJvb3RGb3JtR3JvdXAgPSA8SUZvcm1Hcm91cDxhbnk+PnJvb3RGb3JtR3JvdXAuY29udHJvbHNbY29udHJvbE5hbWVdO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBkaXNhYmxlZENvbHVtbnM7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXREaXNhYmxlZENvbHVtbnMoZm9ybUdyb3VwOiBhbnksIGNvbHVtbk5hbWU6IHN0cmluZywgaXNSb290OiBCb29sZWFuLCBwYXRoTmFtZTogc3RyaW5nID0gXCJcIikge1xyXG4gICAgICAgIGlmIChmb3JtR3JvdXAgJiYgZm9ybUdyb3VwW01PREVMX0lOU1RBTkNFXSkge1xyXG4gICAgICAgICAgICBsZXQgaW5zdGFuY2VDb250YWluZXIgPSBpbnN0YW5jZVByb3ZpZGVyKGZvcm1Hcm91cFtNT0RFTF9JTlNUQU5DRV0uY29uc3RydWN0b3IsIHRoaXMuZW50aXR5T2JqZWN0KTtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Q2hhbmdlRGV0ZWN0aW9uQ29sdW1ucyhpbnN0YW5jZUNvbnRhaW5lciwgY29sdW1uTmFtZSwgaXNSb290LCBwYXRoTmFtZSlcclxuICAgICAgICB9IHJldHVybiBbXTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldENoYW5nZURldGVjdGlvbkNvbHVtbnMoaW5zdGFuY2VDb250YWluZXI6IGFueSwgY29sdW1uTmFtZTogc3RyaW5nLCBpc1Jvb3Q6IEJvb2xlYW4sIHBhdGhOYW1lOiBzdHJpbmcgPSBcIlwiKSB7XHJcbiAgICAgICAgbGV0IGNvbmRpdGlvbmFsRGlzYWJsZUNvbnRyb2xzOiB7IGNvbnRyb2xQYXRoOiBhbnk7IGNvbmRpdGlvbmFsRXhwcmVzc2lvbjogYW55OyBpc1Jvb3Q6IEJvb2xlYW47IH1bXSA9IFtdO1xyXG4gICAgICAgIGxldCBjb2x1bW5zID0gaW5zdGFuY2VDb250YWluZXIubm9uVmFsaWRhdGlvbkRlY29yYXRvcnNbdGhpcy5kZWNvcmF0b3JUeXBlXS5jaGFuZ2VEZXRlY3Rpb25bY29sdW1uTmFtZV1cclxuICAgICAgICBpZiAoY29sdW1ucykge1xyXG4gICAgICAgICAgICBjb2x1bW5zLmZvckVhY2goKHQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uZGl0aW9uYWxEaXNhYmxlQ29udHJvbHMucHVzaCh7IGNvbnRyb2xQYXRoOiBwYXRoTmFtZSA/IGAke3BhdGhOYW1lfS4ke3R9YCA6IHQsIGNvbmRpdGlvbmFsRXhwcmVzc2lvbjogaW5zdGFuY2VDb250YWluZXIubm9uVmFsaWRhdGlvbkRlY29yYXRvcnNbdGhpcy5kZWNvcmF0b3JUeXBlXS5jb25kaXRpb25hbEV4cHJlc3Npb25zW3RdLCBpc1Jvb3Q6IGlzUm9vdCB9KVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gY29uZGl0aW9uYWxEaXNhYmxlQ29udHJvbHM7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSB0b3BDb250cm9sUGF0aChjb250cm9sOiBBYnN0cmFjdENvbnRyb2wsIGNvbHVtbk5hbWU6IHN0cmluZyk6YW55IHtcclxuICAgICAgICBpZiAoY29udHJvbC5wYXJlbnQpIHtcclxuICAgICAgICAgICAgbGV0IG5hbWUgPSB0aGlzLmdldEZvcm1Hcm91cE5hbWUoY29udHJvbC5wYXJlbnQpO1xyXG4gICAgICAgICAgICBpZiAobmFtZSkge1xyXG4gICAgICAgICAgICAgICAgY29sdW1uTmFtZSA9IGAke25hbWV9LiR7Y29sdW1uTmFtZX1gXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy50b3BDb250cm9sUGF0aChjb250cm9sLnBhcmVudCwgY29sdW1uTmFtZSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gY29sdW1uTmFtZTtcclxuICAgIH1cclxuXHJcbiAgICBjaGlsZENvbnRyb2xEaXNhYmxlZEV4cHJlc3Npb24oZm9ybUdyb3VwOiBhbnksIGNvbHVtbk5hbWU6IHN0cmluZywgcGF0aDogc3RyaW5nID0gXCJcIik6IGFueVtdIHtcclxuICAgICAgICBsZXQgZGlzYWJsZWRDb2x1bW5zOiBhbnlbXSAgPSBbXTtcclxuICAgICAgICBpZiAoZm9ybUdyb3VwW01PREVMX0lOU1RBTkNFXSkge1xyXG4gICAgICAgICAgICBsZXQgaW5zdGFuY2VDb250YWluZXIgPSBkZWZhdWx0Q29udGFpbmVyLmdldChmb3JtR3JvdXBbTU9ERUxfSU5TVEFOQ0VdLmNvbnN0cnVjdG9yKTtcclxuICAgICAgICAgICAgaWYgKGluc3RhbmNlQ29udGFpbmVyICYmIGluc3RhbmNlQ29udGFpbmVyLnByb3BlcnRpZXMpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZ2V0Q2hhbmdlRGV0ZWN0aW9uQ29sdW1ucyhpbnN0YW5jZUNvbnRhaW5lciwgY29sdW1uTmFtZSwgdHJ1ZSwgcGF0aCkuZm9yRWFjaCh0ID0+IGRpc2FibGVkQ29sdW1ucy5wdXNoKHQpKTtcclxuICAgICAgICAgICAgICAgIHZhciBwcm9wcyA9IGluc3RhbmNlQ29udGFpbmVyLnByb3BlcnRpZXMuZmlsdGVyKHQgPT4gdC5wcm9wZXJ0eVR5cGUgPT0gT0JKRUNUX1BST1BFUlRZKVxyXG4gICAgICAgICAgICAgICAgcHJvcHMuZm9yRWFjaCh0ID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZm9ybUdyb3VwLmNvbnRyb2xzW3QubmFtZV0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGNvbHVtbnMgPSB0aGlzLmdldERpc2FibGVkQ29sdW1ucyg8YW55PmZvcm1Hcm91cC5jb250cm9sc1t0Lm5hbWVdLCBjb2x1bW5OYW1lLCB0cnVlLCBwYXRoID8gYCR7cGF0aH0uJHt0Lm5hbWV9YCA6IGAke3QubmFtZX1gKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5zLmZvckVhY2goeCA9PiBkaXNhYmxlZENvbHVtbnMucHVzaCh4KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hpbGRDb250cm9sRGlzYWJsZWRFeHByZXNzaW9uKCg8YW55PmZvcm1Hcm91cC5jb250cm9sc1t0Lm5hbWVdKSwgY29sdW1uTmFtZSwgcGF0aCA/IGAke3BhdGh9LiR7dC5uYW1lfWAgOiBgJHt0Lm5hbWV9YCkuZm9yRWFjaCh5ID0+IGRpc2FibGVkQ29sdW1ucy5wdXNoKHkpKVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGRpc2FibGVkQ29sdW1ucztcclxuICAgIH1cclxuXHJcbiAgICBvbmVBcmd1bWVudFByb2Nlc3MoY29udHJvbDogQWJzdHJhY3RDb250cm9sLCBjb2x1bW5OYW1lOiBzdHJpbmcpOiBhbnlbXSB7XHJcbiAgICAgICAgbGV0IHBhdGggPSB0aGlzLnRvcENvbnRyb2xQYXRoKGNvbnRyb2wsIGNvbHVtbk5hbWUpO1xyXG4gICAgICAgIGxldCByb290Rm9ybUdyb3VwID0gQXBwbGljYXRpb25VdGlsLmdldFJvb3RGb3JtR3JvdXAoY29udHJvbCk7XHJcbiAgICAgICAgbGV0IGNoaWxkQ29sdW1ucyA9IHRoaXMuY2hpbGRDb250cm9sRGlzYWJsZWRFeHByZXNzaW9uKHJvb3RGb3JtR3JvdXAsIHBhdGgpO1xyXG4gICAgICAgIHJldHVybiBjaGlsZENvbHVtbnM7XHJcbiAgICB9XHJcbn0iXX0=