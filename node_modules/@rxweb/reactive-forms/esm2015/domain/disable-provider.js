import { defaultContainer } from "../core/defaultContainer";
import { OBJECT_PROPERTY } from "../const/validator.const";
import { ApplicationUtil } from "../util/app-util";
import { RXCODE, MODEL_INSTANCE } from "../const/app.const";
import { instanceProvider } from "../util/instance-provider.function";
export class DisableProvider {
    constructor(decoratorType, entityObject) {
        this.decoratorType = decoratorType;
        this.entityObject = entityObject;
    }
    getFormGroupName(currentFormGroup) {
        let keyName = '';
        if (currentFormGroup.parent)
            for (var controlName of Object.keys(currentFormGroup.parent.controls))
                if (currentFormGroup.parent.controls[controlName] == currentFormGroup) {
                    keyName = controlName;
                    break;
                }
        return keyName;
    }
    zeroArgumentProcess(control, columnName) {
        let disabledColumns = [];
        this.getDisabledColumns(control.parent, `${columnName}${RXCODE}0`, false).forEach(t => disabledColumns.push(t));
        let path = this.topControlPath(control, columnName);
        let splitPath = path.split(".");
        if (splitPath.length > 1) {
            let rootFormGroup = ApplicationUtil.getRootFormGroup(control);
            this.getDisabledColumns(rootFormGroup, `${path}${RXCODE}0`, true).forEach(t => disabledColumns.push(t));
            let controlPath = '';
            for (var i = 0; i < splitPath.length - 2; i++) {
                let controlName = splitPath[i];
                controlPath = `${path.replace(`${controlName}.`, '')}${RXCODE}-0`;
                if (rootFormGroup.controls[controlName]) {
                    this.getDisabledColumns(rootFormGroup.controls[controlName], controlPath, true, controlName).forEach(t => disabledColumns.push(t));
                    rootFormGroup = rootFormGroup.controls[controlName];
                }
            }
        }
        return disabledColumns;
    }
    getDisabledColumns(formGroup, columnName, isRoot, pathName = "") {
        if (formGroup && formGroup[MODEL_INSTANCE]) {
            let instanceContainer = instanceProvider(formGroup[MODEL_INSTANCE].constructor, this.entityObject);
            return this.getChangeDetectionColumns(instanceContainer, columnName, isRoot, pathName);
        }
        return [];
    }
    getChangeDetectionColumns(instanceContainer, columnName, isRoot, pathName = "") {
        let conditionalDisableControls = [];
        let columns = instanceContainer.nonValidationDecorators[this.decoratorType].changeDetection[columnName];
        if (columns) {
            columns.forEach((t) => {
                conditionalDisableControls.push({ controlPath: pathName ? `${pathName}.${t}` : t, conditionalExpression: instanceContainer.nonValidationDecorators[this.decoratorType].conditionalExpressions[t], isRoot: isRoot });
            });
        }
        return conditionalDisableControls;
    }
    topControlPath(control, columnName) {
        if (control.parent) {
            let name = this.getFormGroupName(control.parent);
            if (name) {
                columnName = `${name}.${columnName}`;
                return this.topControlPath(control.parent, columnName);
            }
        }
        return columnName;
    }
    childControlDisabledExpression(formGroup, columnName, path = "") {
        let disabledColumns = [];
        if (formGroup[MODEL_INSTANCE]) {
            let instanceContainer = defaultContainer.get(formGroup[MODEL_INSTANCE].constructor);
            if (instanceContainer && instanceContainer.properties) {
                this.getChangeDetectionColumns(instanceContainer, columnName, true, path).forEach(t => disabledColumns.push(t));
                var props = instanceContainer.properties.filter(t => t.propertyType == OBJECT_PROPERTY);
                props.forEach(t => {
                    if (formGroup.controls[t.name]) {
                        let columns = this.getDisabledColumns(formGroup.controls[t.name], columnName, true, path ? `${path}.${t.name}` : `${t.name}`);
                        columns.forEach(x => disabledColumns.push(x));
                        this.childControlDisabledExpression(formGroup.controls[t.name], columnName, path ? `${path}.${t.name}` : `${t.name}`).forEach(y => disabledColumns.push(y));
                    }
                });
            }
        }
        return disabledColumns;
    }
    oneArgumentProcess(control, columnName) {
        let path = this.topControlPath(control, columnName);
        let rootFormGroup = ApplicationUtil.getRootFormGroup(control);
        let childColumns = this.childControlDisabledExpression(rootFormGroup, path);
        return childColumns;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlzYWJsZS1wcm92aWRlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0ByeHdlYi9yZWFjdGl2ZS1mb3Jtcy8iLCJzb3VyY2VzIjpbImRvbWFpbi9kaXNhYmxlLXByb3ZpZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBRTVELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQTtBQUMxRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDbkQsT0FBTyxFQUFFLE1BQU0sRUFBRSxjQUFjLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUM1RCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQTtBQUlyRSxNQUFNLE9BQU8sZUFBZTtJQUV4QixZQUFvQixhQUFxQixFQUFVLFlBQW9DO1FBQW5FLGtCQUFhLEdBQWIsYUFBYSxDQUFRO1FBQVUsaUJBQVksR0FBWixZQUFZLENBQXdCO0lBRXZGLENBQUM7SUFJRCxnQkFBZ0IsQ0FBQyxnQkFBaUM7UUFDOUMsSUFBSSxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBQ2pCLElBQUksZ0JBQWdCLENBQUMsTUFBTTtZQUN2QixLQUFLLElBQUksV0FBVyxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQztnQkFDakUsSUFBSSxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxJQUFJLGdCQUFnQixFQUFFO29CQUNuRSxPQUFPLEdBQUcsV0FBVyxDQUFDO29CQUN0QixNQUFNO2lCQUNUO1FBQ1QsT0FBTyxPQUFPLENBQUM7SUFDbkIsQ0FBQztJQUVELG1CQUFtQixDQUFDLE9BQXdCLEVBQUUsVUFBa0I7UUFDNUQsSUFBSSxlQUFlLEdBQVUsRUFBRSxDQUFDO1FBQ2hDLElBQUksQ0FBQyxrQkFBa0IsQ0FBa0IsT0FBTyxD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LGVBQWUsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUM5RCxJQUFJLFlBQVksR0FBRyxJQUFJLENBQUMsOEJBQThCLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzVFLE9BQU8sWUFBWSxDQUFDO0lBQ3hCLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGRlZmF1bHRDb250YWluZXIgfSBmcm9tIFwiLi4vY29yZS9kZWZhdWx0Q29udGFpbmVyXCI7XHJcbmltcG9ydCB7IEluc3RhbmNlQ29udGFpbmVyIH0gZnJvbSBcIi4uL2NvcmUvdmFsaWRhdG9yLmludGVyZmFjZVwiO1xyXG5pbXBvcnQgeyBPQkpFQ1RfUFJPUEVSVFkgfSBmcm9tIFwiLi4vY29uc3QvdmFsaWRhdG9yLmNvbnN0XCJcclxuaW1wb3J0IHsgQXBwbGljYXRpb25VdGlsIH0gZnJvbSBcIi4uL3V0aWwvYXBwLXV0aWxcIjtcclxuaW1wb3J0IHsgUlhDT0RFLCBNT0RFTF9JTlNUQU5DRSB9IGZyb20gXCIuLi9jb25zdC9hcHAuY29uc3RcIjtcclxuaW1wb3J0IHsgaW5zdGFuY2VQcm92aWRlciB9IGZyb20gXCIuLi91dGlsL2luc3RhbmNlLXByb3ZpZGVyLmZ1bmN0aW9uXCJcclxuaW1wb3J0IHsgQWJzdHJhY3RDb250cm9sIH0gZnJvbSBcIi4uL2Fic3RyYWN0L2Fic3RyYWN0LWNvbnRyb2xcIjtcclxuaW1wb3J0IHsgSUZvcm1Hcm91cCB9IGZyb20gXCIuLlwiO1xyXG5cclxuZXhwb3J0IGNsYXNzIERpc2FibGVQcm92aWRlciB7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBkZWNvcmF0b3JUeXBlOiBzdHJpbmcsIHByaXZhdGUgZW50aXR5T2JqZWN0OiB7IFtrZXk6IHN0cmluZ106IGFueSB9KSB7XHJcblxyXG4gICAgfVxyXG5cclxuXHJcblxyXG4gICAgZ2V0Rm9ybUdyb3VwTmFtZShjdXJyZW50Rm9ybUdyb3VwOiBJRm9ybUdyb3VwPGFueT4pIHtcclxuICAgICAgICBsZXQga2V5TmFtZSA9ICcnO1xyXG4gICAgICAgIGlmIChjdXJyZW50Rm9ybUdyb3VwLnBhcmVudClcclxuICAgICAgICAgICAgZm9yICh2YXIgY29udHJvbE5hbWUgb2YgT2JqZWN0LmtleXMoY3VycmVudEZvcm1Hcm91cC5wYXJlbnQuY29udHJvbHMpKVxyXG4gICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRGb3JtR3JvdXAucGFyZW50LmNvbnRyb2xzW2NvbnRyb2xOYW1lXSA9PSBjdXJyZW50Rm9ybUdyb3VwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAga2V5TmFtZSA9IGNvbnRyb2xOYW1lO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBrZXlOYW1lO1xyXG4gICAgfVxyXG5cclxuICAgIHplcm9Bcmd1bWVudFByb2Nlc3MoY29udHJvbDogQWJzdHJhY3RDb250cm9sLCBjb2x1bW5OYW1lOiBzdHJpbmcpIHtcclxuICAgICAgICBsZXQgZGlzYWJsZWRDb2x1bW5zOiBhbnlbXSA9IFtdO1xyXG4gICAgICAgIHRoaXMuZ2V0RGlzYWJsZWRDb2x1bW5zKDxJRm9ybUdyb3VwPGFueT4+Y29udHJvbC5wYXJlbnQsIGAke2NvbHVtbk5hbWV9JHtSWENPREV9MGAsIGZhbHNlKS5mb3JFYWNoKHQgPT4gZGlzYWJsZWRDb2x1bW5zLnB1c2godCkpO1xyXG4gICAgICAgIGxldCBwYXRoID0gdGhpcy50b3BDb250cm9sUGF0aChjb250cm9sLCBjb2x1bW5OYW1lKTtcclxuICAgICAgICBsZXQgc3BsaXRQYXRoID0gcGF0aC5zcGxpdChcIi5cIik7XHJcbiAgICAgICAgaWYgKHNwbGl0UGF0aC5sZW5ndGggPiAxKSB7XHJcbiAgICAgICAgICAgIGxldCByb290Rm9ybUdyb3VwID0gQXBwbGljYXRpb25VdGlsLmdldFJvb3RGb3JtR3JvdXAoY29udHJvbCk7XHJcbiAgICAgICAgICAgIHRoaXMuZ2V0RGlzYWJsZWRDb2x1bW5zKHJvb3RGb3JtR3JvdXAsIGAke3BhdGh9JHtSWENPREV9MGAsIHRydWUpLmZvckVhY2godCA9PiBkaXNhYmxlZENvbHVtbnMucHVzaCh0KSk7XHJcbiAgICAgICAgICAgIGxldCBjb250cm9sUGF0aDogc3RyaW5nID0gJyc7XHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3BsaXRQYXRoLmxlbmd0aCAtIDI7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgbGV0IGNvbnRyb2xOYW1lID0gc3BsaXRQYXRoW2ldO1xyXG4gICAgICAgICAgICAgICAgY29udHJvbFBhdGggPSBgJHtwYXRoLnJlcGxhY2UoYCR7Y29udHJvbE5hbWV9LmAsICcnKX0ke1JYQ09ERX0tMGBcclxuICAgICAgICAgICAgICAgIGlmIChyb290Rm9ybUdyb3VwLmNvbnRyb2xzW2NvbnRyb2xOYW1lXSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0RGlzYWJsZWRDb2x1bW5zKDxJRm9ybUdyb3VwPGFueT4+cm9vdEZvcm1Hcm91cC5jb250cm9sc1tjb250cm9sTmFtZV0sIGNvbnRyb2xQYXRoLCB0cnVlLCBjb250cm9sTmFtZSkuZm9yRWFjaCh0ID0+IGRpc2FibGVkQ29sdW1ucy5wdXNoKHQpKTtcclxuICAgICAgICAgICAgICAgICAgICByb290Rm9ybUdyb3VwID0gPElGb3JtR3JvdXA8YW55Pj5yb290Rm9ybUdyb3VwLmNvbnRyb2xzW2NvbnRyb2xOYW1lXTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZGlzYWJsZWRDb2x1bW5zO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0RGlzYWJsZWRDb2x1bW5zKGZvcm1Hcm91cDogYW55LCBjb2x1bW5OYW1lOiBzdHJpbmcsIGlzUm9vdDogQm9vbGVhbiwgcGF0aE5hbWU6IHN0cmluZyA9IFwiXCIpIHtcclxuICAgICAgICBpZiAoZm9ybUdyb3VwICYmIGZvcm1Hcm91cFtNT0RFTF9JTlNUQU5DRV0pIHtcclxuICAgICAgICAgICAgbGV0IGluc3RhbmNlQ29udGFpbmVyID0gaW5zdGFuY2VQcm92aWRlcihmb3JtR3JvdXBbTU9ERUxfSU5TVEFOQ0VdLmNvbnN0cnVjdG9yLCB0aGlzLmVudGl0eU9iamVjdCk7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldENoYW5nZURldGVjdGlvbkNvbHVtbnMoaW5zdGFuY2VDb250YWluZXIsIGNvbHVtbk5hbWUsIGlzUm9vdCwgcGF0aE5hbWUpXHJcbiAgICAgICAgfSByZXR1cm4gW107XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRDaGFuZ2VEZXRlY3Rpb25Db2x1bW5zKGluc3RhbmNlQ29udGFpbmVyOiBhbnksIGNvbHVtbk5hbWU6IHN0cmluZywgaXNSb290OiBCb29sZWFuLCBwYXRoTmFtZTogc3RyaW5nID0gXCJcIikge1xyXG4gICAgICAgIGxldCBjb25kaXRpb25hbERpc2FibGVDb250cm9sczogeyBjb250cm9sUGF0aDogYW55OyBjb25kaXRpb25hbEV4cHJlc3Npb246IGFueTsgaXNSb290OiBCb29sZWFuOyB9W10gPSBbXTtcclxuICAgICAgICBsZXQgY29sdW1ucyA9IGluc3RhbmNlQ29udGFpbmVyLm5vblZhbGlkYXRpb25EZWNvcmF0b3JzW3RoaXMuZGVjb3JhdG9yVHlwZV0uY2hhbmdlRGV0ZWN0aW9uW2NvbHVtbk5hbWVdXHJcbiAgICAgICAgaWYgKGNvbHVtbnMpIHtcclxuICAgICAgICAgICAgY29sdW1ucy5mb3JFYWNoKCh0OiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbmRpdGlvbmFsRGlzYWJsZUNvbnRyb2xzLnB1c2goeyBjb250cm9sUGF0aDogcGF0aE5hbWUgPyBgJHtwYXRoTmFtZX0uJHt0fWAgOiB0LCBjb25kaXRpb25hbEV4cHJlc3Npb246IGluc3RhbmNlQ29udGFpbmVyLm5vblZhbGlkYXRpb25EZWNvcmF0b3JzW3RoaXMuZGVjb3JhdG9yVHlwZV0uY29uZGl0aW9uYWxFeHByZXNzaW9uc1t0XSwgaXNSb290OiBpc1Jvb3QgfSlcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGNvbmRpdGlvbmFsRGlzYWJsZUNvbnRyb2xzO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgdG9wQ29udHJvbFBhdGgoY29udHJvbDogQWJzdHJhY3RDb250cm9sLCBjb2x1bW5OYW1lOiBzdHJpbmcpOmFueSB7XHJcbiAgICAgICAgaWYgKGNvbnRyb2wucGFyZW50KSB7XHJcbiAgICAgICAgICAgIGxldCBuYW1lID0gdGhpcy5nZXRGb3JtR3JvdXBOYW1lKGNvbnRyb2wucGFyZW50KTtcclxuICAgICAgICAgICAgaWYgKG5hbWUpIHtcclxuICAgICAgICAgICAgICAgIGNvbHVtbk5hbWUgPSBgJHtuYW1lfS4ke2NvbHVtbk5hbWV9YFxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudG9wQ29udHJvbFBhdGgoY29udHJvbC5wYXJlbnQsIGNvbHVtbk5hbWUpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGNvbHVtbk5hbWU7XHJcbiAgICB9XHJcblxyXG4gICAgY2hpbGRDb250cm9sRGlzYWJsZWRFeHByZXNzaW9uKGZvcm1Hcm91cDogYW55LCBjb2x1bW5OYW1lOiBzdHJpbmcsIHBhdGg6IHN0cmluZyA9IFwiXCIpOiBhbnlbXSB7XHJcbiAgICAgICAgbGV0IGRpc2FibGVkQ29sdW1uczogYW55W10gID0gW107XHJcbiAgICAgICAgaWYgKGZvcm1Hcm91cFtNT0RFTF9JTlNUQU5DRV0pIHtcclxuICAgICAgICAgICAgbGV0IGluc3RhbmNlQ29udGFpbmVyID0gZGVmYXVsdENvbnRhaW5lci5nZXQoZm9ybUdyb3VwW01PREVMX0lOU1RBTkNFXS5jb25zdHJ1Y3Rvcik7XHJcbiAgICAgICAgICAgIGlmIChpbnN0YW5jZUNvbnRhaW5lciAmJiBpbnN0YW5jZUNvbnRhaW5lci5wcm9wZXJ0aWVzKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmdldENoYW5nZURldGVjdGlvbkNvbHVtbnMoaW5zdGFuY2VDb250YWluZXIsIGNvbHVtbk5hbWUsIHRydWUsIHBhdGgpLmZvckVhY2godCA9PiBkaXNhYmxlZENvbHVtbnMucHVzaCh0KSk7XHJcbiAgICAgICAgICAgICAgICB2YXIgcHJvcHMgPSBpbnN0YW5jZUNvbnRhaW5lci5wcm9wZXJ0aWVzLmZpbHRlcih0ID0+IHQucHJvcGVydHlUeXBlID09IE9CSkVDVF9QUk9QRVJUWSlcclxuICAgICAgICAgICAgICAgIHByb3BzLmZvckVhY2godCA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZvcm1Hcm91cC5jb250cm9sc1t0Lm5hbWVdKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBjb2x1bW5zID0gdGhpcy5nZXREaXNhYmxlZENvbHVtbnMoPGFueT5mb3JtR3JvdXAuY29udHJvbHNbdC5uYW1lXSwgY29sdW1uTmFtZSwgdHJ1ZSwgcGF0aCA/IGAke3BhdGh9LiR7dC5uYW1lfWAgOiBgJHt0Lm5hbWV9YClcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1ucy5mb3JFYWNoKHggPT4gZGlzYWJsZWRDb2x1bW5zLnB1c2goeCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoaWxkQ29udHJvbERpc2FibGVkRXhwcmVzc2lvbigoPGFueT5mb3JtR3JvdXAuY29udHJvbHNbdC5uYW1lXSksIGNvbHVtbk5hbWUsIHBhdGggPyBgJHtwYXRofS4ke3QubmFtZX1gIDogYCR7dC5uYW1lfWApLmZvckVhY2goeSA9PiBkaXNhYmxlZENvbHVtbnMucHVzaCh5KSlcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBkaXNhYmxlZENvbHVtbnM7XHJcbiAgICB9XHJcblxyXG4gICAgb25lQXJndW1lbnRQcm9jZXNzKGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbCwgY29sdW1uTmFtZTogc3RyaW5nKTogYW55W10ge1xyXG4gICAgICAgIGxldCBwYXRoID0gdGhpcy50b3BDb250cm9sUGF0aChjb250cm9sLCBjb2x1bW5OYW1lKTtcclxuICAgICAgICBsZXQgcm9vdEZvcm1Hcm91cCA9IEFwcGxpY2F0aW9uVXRpbC5nZXRSb290Rm9ybUdyb3VwKGNvbnRyb2wpO1xyXG4gICAgICAgIGxldCBjaGlsZENvbHVtbnMgPSB0aGlzLmNoaWxkQ29udHJvbERpc2FibGVkRXhwcmVzc2lvbihyb290Rm9ybUdyb3VwLCBwYXRoKTtcclxuICAgICAgICByZXR1cm4gY2hpbGRDb2x1bW5zO1xyXG4gICAgfVxyXG59Il19