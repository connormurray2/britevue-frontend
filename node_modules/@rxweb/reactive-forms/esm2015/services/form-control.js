import { ObjectMaker } from "../util/object-maker";
import { MESSAGE, CONTROLS_ERROR, VALUE_CHANGED_SYNC } from '../const';
import { ApplicationUtil } from '../util/app-util';
import { DisableProvider } from '../domain/disable-provider';
import { RXCODE, MODEL_INSTANCE, PATCH } from "../const/app.const";
import { DECORATORS } from "../const/decorators.const";
import { defaultContainer } from "../core/defaultContainer";
import { SANITIZERS } from "../util/sanitizers";
import { ErrorMessageBindingStrategy } from "../enums";
import { ReactiveFormConfig } from "../util/reactive-form-config";
import { AbstractControl } from "../abstract/abstract-control";
const DIRTY = "dirty";
const TOUCHED = "touched";
const UNTOUCHED = "untouched";
const PRISTINE = "pristine";
const PENDING = "pending";
export class RxFormControl extends AbstractControl {
    constructor(formState, validator, asyncValidator, entityObject, baseObject, controlName, _sanitizers) {
        super(formState, validator, asyncValidator);
        this.entityObject = entityObject;
        this.baseObject = baseObject;
        this._sanitizers = _sanitizers;
        this._errorMessages = [];
        this._childColumns = [];
        this._refDisableControls = [];
        this._refMessageControls = [];
        this._refClassNameControls = [];
        this._isPassedExpression = false;
        this._baseValue = formState === undefined ? null : this.getFormState(formState);
        this._isModified = false;
        this.keyName = controlName;
        this._errorMessageBindingStrategy = ReactiveFormConfig.get("reactiveForm.errorMessageBindingStrategy");
        this.updateValueAndValidity();
    }
    get path() {
        return this.parent ? `${this.parent.path}.${this.keyName}` : "";
    }
    get errorMessages() {
        if (!this._messageExpression) {
            if (this._errorMessages.length == 0 && this.errors)
                this.setControlErrorMessages();
        }
        else if (this._messageExpression && !this._isPassedExpression)
            return [];
        if (!this.errors && this._errorMessages.length > 0)
            this.setControlErrorMessages();
        return this._errorMessages;
    }
    get errorMessage() {
        if (!this._messageExpression) {
            if (this._errorMessage == undefined && this.errors)
                this.setControlErrorMessages();
        }
        else if (this._messageExpression && !this._isPassedExpression)
            return undefined;
        if (!this.errors && this._errorMessage)
            this.setControlErrorMessages();
        return this._errorMessage;
    }
    getFormState(value) {
        let baseValue = value;
        if (Array.isArray(value)) {
            baseValue = [];
            value.forEach(t => baseValue.push(t));
        }
        return baseValue;
    }
    get isModified() {
        return this._isModified;
    }
    setValue(value, options) {
        let parsedValue = this.getSanitizedValue(value);
        if (options && options.dirty)
            this.baseObject[this.keyName] = value;
        this.entityObject[this.keyName] = parsedValue;
        this.value = value;
        this.bindError();
        this.bindClassName();
        this.executeExpressions();
        this.callPatch();
        if (options && !options.updateChanged && this.root[VALUE_CHANGED_SYNC]) {
            this.root[VALUE_CHANGED_SYNC]();
        }
    }
    getControlValue() {
        return this.getSanitizedValue(this.value);
    }
    bindError() {
        if (this._messageExpression)
            this._isPassedExpression = this.executeExpression(this._messageExpression, this);
        this.setControlErrorMessages();
        this.errors = this.errors;
    }
    bindClassName() {
        if (this.updateOnElementClass && typeof this.updateOnElementClass === "function") {
            let className = this.executeExpression(this._classNameExpression, this);
            let updateElement = this.updateOnElementClass;
            updateElement(className);
        }
    }
    markAsTouched(opts) {
        let currentState = this.touched;
        super.markAsTouched();
        if (currentState != this.touched)
            this.runControlPropChangeExpression([TOUCHED, UNTOUCHED]);
    }
    markAsUntouched(opts) {
        let currentState = this.untouched;
        //super.markAsUnTouched();
        //super.markAsUnTouched();
        if (currentState != this.untouched)
            this.runControlPropChangeExpression([UNTOUCHED, TOUCHED]);
    }
    markAsDirty(opts) {
        let currentState = this.dirty;
        super.markAsDirty();
        if (currentState != this.dirty)
            this.runControlPropChangeExpression([DIRTY]);
    }
    markAsPristine(opts) {
        let currentState = this.pristine;
        super.markAsDirty();
        if (currentState != this.pristine)
            this.runControlPropChangeExpression([PRISTINE]);
    }
    runControlPropChangeExpression(propNames) {
        propNames.forEach(name => {
            if ((this._controlProp && this._messageExpression && this._controlProp[name]) || (!this._messageExpression && this.checkErrorMessageStrategy()))
                this.bindError();
            if (this._classNameControlProp && this._classNameControlProp[name])
                this.bindClassName();
        });
    }
    refresh() {
        this.getMessageExpression(this.parent, this.keyName);
        this.bindConditionalControls(DECORATORS.disabled, "_refDisableControls");
        this.bindConditionalControls(DECORATORS.error, "_refMessageControls");
        this.bindConditionalControls(DECORATORS.elementClass, "_refClassNameControls");
        this.executeExpressions();
        this.bindError();
    }
    reset(value) {
        if (value !== undefined)
            this.setValue(value);
        else
            this.setValue(this.getFormState(this._baseValue));
    }
    commit() {
        this._baseValue = this.value;
        this.callPatch();
    }
    callPatch() {
        this._isModified = this.getValue(this._baseValue) != this.getValue(this.value);
        if (this.parent && this.parent[PATCH])
            this.parent[PATCH](this.keyName);
    }
    checkErrorMessageStrategy() {
        let isBind = true;
        switch (this._errorMessageBindingStrategy) {
            case ErrorMessageBindingStrategy.OnSubmit:
                isBind = this.parent.submitted;
                break;
            case ErrorMessageBindingStrategy.OnDirty:
                isBind = this.dirty;
                break;
            case ErrorMessageBindingStrategy.OnDirtyOrSubmit:
                isBind = this.dirty || this.parent.submitted;
                break;
            default:
                isBind = true;
        }
        return isBind;
    }
    executeExpressions() {
        this.processExpression("_refDisableControls", "disabled");
        this.processExpression("_refMessageControls", "bindError");
        this.processExpression("_refClassNameControls", "bindClassName");
    }
    getMessageExpression(formGroup, keyName) {
        if (formGroup && formGroup.modelInstance) {
            let instanceContainer = defaultContainer.get(formGroup.modelInstance.constructor);
            if (instanceContainer) {
                this._messageExpression = instanceContainer.nonValidationDecorators.error.conditionalExpressions[keyName];
                this._controlProp = instanceContainer.nonValidationDecorators.error.controlProp[this.keyName];
                this._classNameExpression = instanceContainer.nonValidationDecorators.elementClass.conditionalExpressions[keyName];
                this._classNameControlProp = instanceContainer.nonValidationDecorators.elementClass.controlProp[keyName];
                if (this._classNameExpression)
                    this.updateOnElementClass = true;
            }
        }
    }
    getSanitizedValue(value) {
        if (this._sanitizers) {
            for (let sanitizer of this._sanitizers) {
                value = SANITIZERS[sanitizer.name](value, sanitizer.config);
            }
        }
        return value;
    }
    bindConditionalControls(decoratorType, refName) {
        let _this = this;
        this._disableProvider = new DisableProvider(decoratorType, this.entityObject);
        _this[refName] = this._disableProvider.zeroArgumentProcess(this, this.keyName);
        this._disableProvider.oneArgumentProcess(this, `${this.keyName}${RXCODE}1`).forEach(t => _this[refName].push(t));
    }
    setControlErrorMessages() {
        if ((!this._messageExpression && this.checkErrorMessageStrategy()) || this._isPassedExpression) {
            this._errorMessages = [];
            if (this.errors) {
                Object.keys(this.errors).forEach(t => {
                    this.parent[CONTROLS_ERROR][this.keyName] = this._errorMessage = this.getErrorMessage(this.errors, t);
                    if (!this._errorMessage) {
                        let errorObject = ObjectMaker.toJson(t, undefined, [this.errors[t][t]]);
                        this.parent[CONTROLS_ERROR][this.keyName] = this._errorMessage = this.getErrorMessage(errorObject, t);
                    }
                    this._errorMessages.push(this._errorMessage);
                });
            }
            else {
                this._errorMessage = undefined;
                this.parent[CONTROLS_ERROR][this.keyName] = undefined;
                delete this.parent[CONTROLS_ERROR][this.keyName];
            }
        }
        else {
            this._errorMessages = [];
            this._errorMessage = undefined;
        }
    }
    getErrorMessage(errorObject, keyName) {
        if (errorObject[keyName][MESSAGE])
            return errorObject[keyName][MESSAGE];
        return;
    }
    processExpression(propName, operationType) {
        let _this = this;
        if (_this[propName])
            for (var controlInfo of _this[propName]) {
                let control = controlInfo.isRoot ? ApplicationUtil.getControl(controlInfo.controlPath, ApplicationUtil.getRootFormGroup(this)) : ApplicationUtil.getFormControl(controlInfo.controlPath, this);
                if (control) {
                    if (operationType == "disabled") {
                        let result = this.executeExpression(controlInfo.conditionalExpression, control);
                        if (result)
                            control.disable();
                        else
                            control.enable();
                    }
                    else if (operationType == "bindError")
                        control.bindError();
                    else if (operationType == "bindClassName")
                        control.bindClassName();
                }
            }
    }
    executeExpression(expression, control) {
        return expression.call(control.parent[MODEL_INSTANCE], control, ApplicationUtil.getParentModelInstanceValue(this), control.parent[MODEL_INSTANCE]);
    }
    getValue(value) {
        return value !== undefined && value !== null && value !== "" ? value : "";
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS1jb250cm9sLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHJ4d2ViL3JlYWN0aXZlLWZvcm1zLyIsInNvdXJjZXMiOlsic2VydmljZXMvZm9ybS1jb250cm9sLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNuRCxPQUFPLEVBQUUsT0FBTyxFQUFFLGNBQWMsRUFBRSxrQkFBa0IsRUFBRSxNQUFNLFVBQVUsQ0FBQTtBQUN0RSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sa0JBQWtCLENBQUE7QUFDbEQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQzdELE9BQU8sRUFBRSxNQUFNLEVBQUUsY0FBYyxFQUFFLEtBQUssRUFBRSxNQUFNLG9CQUFvQixDQUFBO0FBQ2xFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUM1RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sb0JBQW9CLENBQUE7QUFFL0MsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ3ZELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQ2xFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUcvRCxNQUFNLEtBQUssR0FBVSxPQUFPLENBQUM7QUFDN0IsTUFBTSxPQUFPLEdBQVUsU0FBUyxDQUFDO0FBQ2pDLE1BQU0sU0FBUyxHQUFVLFdBQVcsQ0FBQztBQUNyQyxNQUFNLFFBQVEsR0FBVSxVQUFVLENBQUM7QUFDbkMsTUFBTSxPQUFPLEdBQVUsU0FBUyxDQUFDO0FBRWpDLE1BQU0sT0FBTyxhQUFjLFNBQVEsZUFBZTtJQW1EOUMsWUFBWSxTQUFjLEVBQUUsU0FBZ0IsRUFBRSxjQUFxQixFQUFVLFlBQW9DLEVBQVUs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QUFLLFNBQVMsSUFBSSxLQUFLLEtBQUssSUFBSSxJQUFJLEtBQUssS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQzlFLENBQUM7Q0FFSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9iamVjdE1ha2VyIH0gZnJvbSBcIi4uL3V0aWwvb2JqZWN0LW1ha2VyXCI7XHJcbmltcG9ydCB7IE1FU1NBR0UsIENPTlRST0xTX0VSUk9SLCBWQUxVRV9DSEFOR0VEX1NZTkMgfSBmcm9tICcuLi9jb25zdCdcclxuaW1wb3J0IHsgQXBwbGljYXRpb25VdGlsIH0gZnJvbSAnLi4vdXRpbC9hcHAtdXRpbCdcclxuaW1wb3J0IHsgRGlzYWJsZVByb3ZpZGVyIH0gZnJvbSAnLi4vZG9tYWluL2Rpc2FibGUtcHJvdmlkZXInO1xyXG5pbXBvcnQgeyBSWENPREUsIE1PREVMX0lOU1RBTkNFLCBQQVRDSCB9IGZyb20gXCIuLi9jb25zdC9hcHAuY29uc3RcIlxyXG5pbXBvcnQgeyBERUNPUkFUT1JTIH0gZnJvbSBcIi4uL2NvbnN0L2RlY29yYXRvcnMuY29uc3RcIjtcclxuaW1wb3J0IHsgZGVmYXVsdENvbnRhaW5lciB9IGZyb20gXCIuLi9jb3JlL2RlZmF1bHRDb250YWluZXJcIjtcclxuaW1wb3J0IHsgU0FOSVRJWkVSUyB9IGZyb20gXCIuLi91dGlsL3Nhbml0aXplcnNcIlxyXG5pbXBvcnQgeyBEYXRhU2FuaXRpemVyIH0gZnJvbSAnLi4vY29yZS92YWxpZGF0b3IuaW50ZXJmYWNlJ1xyXG5pbXBvcnQgeyBFcnJvck1lc3NhZ2VCaW5kaW5nU3RyYXRlZ3kgfSBmcm9tIFwiLi4vZW51bXNcIjtcclxuaW1wb3J0IHsgUmVhY3RpdmVGb3JtQ29uZmlnIH0gZnJvbSBcIi4uL3V0aWwvcmVhY3RpdmUtZm9ybS1jb25maWdcIjtcclxuaW1wb3J0IHsgQWJzdHJhY3RDb250cm9sIH0gZnJvbSBcIi4uL2Fic3RyYWN0L2Fic3RyYWN0LWNvbnRyb2xcIjtcclxuaW1wb3J0IHsgSUZvcm1Hcm91cCB9IGZyb20gXCIuLi9tb2RlbHMvaW50ZXJmYWNlL2ktZm9ybS1ncm91cFwiO1xyXG5cclxuY29uc3QgRElSVFk6c3RyaW5nID0gXCJkaXJ0eVwiO1xyXG5jb25zdCBUT1VDSEVEOnN0cmluZyA9IFwidG91Y2hlZFwiO1xyXG5jb25zdCBVTlRPVUNIRUQ6c3RyaW5nID0gXCJ1bnRvdWNoZWRcIjtcclxuY29uc3QgUFJJU1RJTkU6c3RyaW5nID0gXCJwcmlzdGluZVwiO1xyXG5jb25zdCBQRU5ESU5HOnN0cmluZyA9IFwicGVuZGluZ1wiO1xyXG5cclxuZXhwb3J0IGNsYXNzIFJ4Rm9ybUNvbnRyb2wgZXh0ZW5kcyBBYnN0cmFjdENvbnRyb2wge1xyXG4gICAgcHJpdmF0ZSBrZXlOYW1lOiBzdHJpbmc7XHJcbiAgICBwcml2YXRlIF9lcnJvck1lc3NhZ2UhOiBhbnk7XHJcbiAgICBwcml2YXRlIF9lcnJvck1lc3NhZ2VzOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgcHJpdmF0ZSBfZGlzYWJsZVByb3ZpZGVyITogRGlzYWJsZVByb3ZpZGVyO1xyXG4gICAgcHJpdmF0ZSBfY29sdW1ucyE6IHN0cmluZ1tdO1xyXG4gICAgcHJpdmF0ZSBfY2hpbGRDb2x1bW5zOiBhbnkgPSBbXTtcclxuICAgIHByaXZhdGUgX3BhcmVudENvbHVtbnMhOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZ1tdIH07XHJcbiAgICBwcml2YXRlIF9yZWZEaXNhYmxlQ29udHJvbHM9IFtdO1xyXG4gICAgcHJpdmF0ZSBfcmVmTWVzc2FnZUNvbnRyb2xzID0gW107XHJcbiAgICBwcml2YXRlIF9yZWZDbGFzc05hbWVDb250cm9scyA9IFtdO1xyXG4gICAgcHJpdmF0ZSBfZXJyb3JNZXNzYWdlQmluZGluZ1N0cmF0ZWd5OiBFcnJvck1lc3NhZ2VCaW5kaW5nU3RyYXRlZ3k7XHJcbiAgICBwcml2YXRlIF9tZXNzYWdlRXhwcmVzc2lvbiE6IEZ1bmN0aW9uO1xyXG4gICAgcHJpdmF0ZSBfY2xhc3NOYW1lRXhwcmVzc2lvbiE6IEZ1bmN0aW9uO1xyXG4gICAgcHJpdmF0ZSBfaXNQYXNzZWRFeHByZXNzaW9uOiBCb29sZWFuID0gZmFsc2U7XHJcbiAgICBwcml2YXRlIF9jb250cm9sUHJvcCE6IHsgW2tleTogc3RyaW5nXTogYm9vbGVhbiB9O1xyXG4gICAgcHJpdmF0ZSBfY2xhc3NOYW1lQ29udHJvbFByb3AhOiB7IFtrZXk6IHN0cmluZ106IGJvb2xlYW4gfTtcclxuICAgIHByaXZhdGUgX2Jhc2VWYWx1ZTogYW55O1xyXG4gICAgcHJpdmF0ZSBfaXNNb2RpZmllZDogYm9vbGVhbjtcclxuICAgIHVwZGF0ZU9uRWxlbWVudENsYXNzITogYm9vbGVhbiB8IEZ1bmN0aW9uO1xyXG4gICAgcHJlSG9vayE6IEZ1bmN0aW9uO1xyXG4gICAgcG9zdEhvb2shOiBGdW5jdGlvbjtcclxuXHJcbiAgICBnZXQgcGF0aCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5wYXJlbnQgPyBgJHt0aGlzLnBhcmVudC5wYXRofS4ke3RoaXMua2V5TmFtZX1gIDogXCJcIjtcclxuICAgIH1cclxuXHJcblxyXG4gICAgZ2V0IGVycm9yTWVzc2FnZXMoKTogc3RyaW5nW10ge1xyXG4gICAgICAgIGlmICghdGhpcy5fbWVzc2FnZUV4cHJlc3Npb24pIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuX2Vycm9yTWVzc2FnZXMubGVuZ3RoID09IDAgJiYgdGhpcy5lcnJvcnMpXHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldENvbnRyb2xFcnJvck1lc3NhZ2VzKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2UgaWYodGhpcy5fbWVzc2FnZUV4cHJlc3Npb24gJiYgIXRoaXMuX2lzUGFzc2VkRXhwcmVzc2lvbilcclxuICAgICAgICAgICAgcmV0dXJuIFtdO1xyXG4gICAgICAgIGlmICghdGhpcy5lcnJvcnMgJiYgdGhpcy5fZXJyb3JNZXNzYWdlcy5sZW5ndGggPiAwKVxyXG4gICAgICAgICAgICB0aGlzLnNldENvbnRyb2xFcnJvck1lc3NhZ2VzKCk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2Vycm9yTWVzc2FnZXM7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGVycm9yTWVzc2FnZSgpOiBzdHJpbmcgfCB1bmRlZmluZWR7XHJcbiAgICAgICAgaWYgKCF0aGlzLl9tZXNzYWdlRXhwcmVzc2lvbikge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5fZXJyb3JNZXNzYWdlID09IHVuZGVmaW5lZCAmJiB0aGlzLmVycm9ycylcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0Q29udHJvbEVycm9yTWVzc2FnZXMoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZih0aGlzLl9tZXNzYWdlRXhwcmVzc2lvbiAmJiAhdGhpcy5faXNQYXNzZWRFeHByZXNzaW9uKVxyXG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgICAgIGlmICghdGhpcy5lcnJvcnMgJiYgdGhpcy5fZXJyb3JNZXNzYWdlKVxyXG4gICAgICAgICAgICB0aGlzLnNldENvbnRyb2xFcnJvck1lc3NhZ2VzKCk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2Vycm9yTWVzc2FnZTtcclxuICAgIH1cclxuICAgIGNvbnN0cnVjdG9yKGZvcm1TdGF0ZTogYW55LCB2YWxpZGF0b3I6IGFueVtdLCBhc3luY1ZhbGlkYXRvcjogYW55W10sIHByaXZhdGUgZW50aXR5T2JqZWN0OiB7IFtrZXk6IHN0cmluZ106IGFueSB9LCBwcml2YXRlIGJhc2VPYmplY3Q6IHsgW2tleTogc3RyaW5nXTogYW55IH0sIGNvbnRyb2xOYW1lOiBzdHJpbmcsIHByaXZhdGUgX3Nhbml0aXplcnM6IERhdGFTYW5pdGl6ZXJbXSkge1xyXG4gICAgICAgIHN1cGVyKGZvcm1TdGF0ZSx2YWxpZGF0b3IsIGFzeW5jVmFsaWRhdG9yKVxyXG4gICAgICAgIHRoaXMuX2Jhc2VWYWx1ZSA9IGZvcm1TdGF0ZSA9PT0gdW5kZWZpbmVkID8gbnVsbCA6IHRoaXMuZ2V0Rm9ybVN0YXRlKGZvcm1TdGF0ZSk7XHJcbiAgICAgICAgdGhpcy5faXNNb2RpZmllZCA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMua2V5TmFtZSA9IGNvbnRyb2xOYW1lO1xyXG4gICAgICAgIHRoaXMuX2Vycm9yTWVzc2FnZUJpbmRpbmdTdHJhdGVneSA9IFJlYWN0aXZlRm9ybUNvbmZpZy5nZXQoXCJyZWFjdGl2ZUZvcm0uZXJyb3JNZXNzYWdlQmluZGluZ1N0cmF0ZWd5XCIpIGFzIEVycm9yTWVzc2FnZUJpbmRpbmdTdHJhdGVneTtcclxuICAgICAgICB0aGlzLnVwZGF0ZVZhbHVlQW5kVmFsaWRpdHkoKTsgICAgXHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRGb3JtU3RhdGUodmFsdWU6YW55KSB7XHJcbiAgICAgICAgbGV0IGJhc2VWYWx1ZSA9IHZhbHVlXHJcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XHJcbiAgICAgICAgICAgIGJhc2VWYWx1ZSA9IFtdO1xyXG4gICAgICAgICAgICB2YWx1ZS5mb3JFYWNoKHQgPT4gYmFzZVZhbHVlLnB1c2godCkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gYmFzZVZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBpc01vZGlmaWVkKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9pc01vZGlmaWVkO1xyXG4gICAgfVxyXG5cclxuICAgIHNldFZhbHVlKHZhbHVlOiBhbnksIG9wdGlvbnM/OiB7XHJcbiAgICAgICAgZGlydHk/OiBib29sZWFuO1xyXG4gICAgICAgIHVwZGF0ZUNoYW5nZWQ/OiBib29sZWFuO1xyXG4gICAgICAgIG9ubHlTZWxmPzogYm9vbGVhbjtcclxuICAgICAgICBlbWl0RXZlbnQ/OiBib29sZWFuO1xyXG4gICAgICAgIGlzVGhyb3VnaER5bmFtaWM/OiBib29sZWFuO1xyXG4gICAgfSk6IHZvaWQge1xyXG4gICAgICAgICAgICBsZXQgcGFyc2VkVmFsdWUgPSB0aGlzLmdldFNhbml0aXplZFZhbHVlKHZhbHVlKVxyXG4gICAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmRpcnR5KVxyXG4gICAgICAgICAgICAgICAgdGhpcy5iYXNlT2JqZWN0W3RoaXMua2V5TmFtZV0gPSB2YWx1ZTtcclxuICAgICAgICB0aGlzLmVudGl0eU9iamVjdFt0aGlzLmtleU5hbWVdID0gcGFyc2VkVmFsdWU7XHJcbiAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgdGhpcy5iaW5kRXJyb3IoKTtcclxuICAgICAgICAgICAgdGhpcy5iaW5kQ2xhc3NOYW1lKCk7XHJcbiAgICAgICAgICAgIHRoaXMuZXhlY3V0ZUV4cHJlc3Npb25zKCk7XHJcbiAgICAgICAgICAgIHRoaXMuY2FsbFBhdGNoKCk7XHJcbiAgICAgICAgICAgIGlmIChvcHRpb25zICYmICFvcHRpb25zLnVwZGF0ZUNoYW5nZWQgJiYgdGhpcy5yb290W1ZBTFVFX0NIQU5HRURfU1lOQ10pIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucm9vdFtWQUxVRV9DSEFOR0VEX1NZTkNdKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXRDb250cm9sVmFsdWUoKXtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRTYW5pdGl6ZWRWYWx1ZSh0aGlzLnZhbHVlKTtcclxuICAgIH1cclxuXHJcbiAgICBiaW5kRXJyb3IoKXtcclxuICAgICAgICBpZih0aGlzLl9tZXNzYWdlRXhwcmVzc2lvbilcclxuICAgICAgICAgICAgdGhpcy5faXNQYXNzZWRFeHByZXNzaW9uID0gdGhpcy5leGVjdXRlRXhwcmVzc2lvbih0aGlzLl9tZXNzYWdlRXhwcmVzc2lvbix0aGlzKTtcclxuICAgICAgICB0aGlzLnNldENvbnRyb2xFcnJvck1lc3NhZ2VzKCk7XHJcbiAgICAgICAgdGhpcy5lcnJvcnMgPSB0aGlzLmVycm9ycztcclxuICAgIH1cclxuXHJcbiAgICBiaW5kQ2xhc3NOYW1lKCkge1xyXG4gICAgICAgIGlmICh0aGlzLnVwZGF0ZU9uRWxlbWVudENsYXNzICYmIHR5cGVvZiB0aGlzLnVwZGF0ZU9uRWxlbWVudENsYXNzID09PSBcImZ1bmN0aW9uXCIpIHtcclxuICAgICAgICAgICAgbGV0IGNsYXNzTmFtZSA9IHRoaXMuZXhlY3V0ZUV4cHJlc3Npb24odGhpcy5fY2xhc3NOYW1lRXhwcmVzc2lvbiwgdGhpcyk7XHJcbiAgICAgICAgICAgIGxldCB1cGRhdGVFbGVtZW50ID0gdGhpcy51cGRhdGVPbkVsZW1lbnRDbGFzcyBhcyBGdW5jdGlvbjtcclxuICAgICAgICAgICAgdXBkYXRlRWxlbWVudChjbGFzc05hbWUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBtYXJrQXNUb3VjaGVkKG9wdHM/OiB7XHJcbiAgICAgICAgb25seVNlbGY/OiBib29sZWFuO1xyXG4gICAgfSk6IHZvaWQge1xyXG4gICAgICAgIGxldCBjdXJyZW50U3RhdGUgPSB0aGlzLnRvdWNoZWQ7XHJcbiAgICAgICAgc3VwZXIubWFya0FzVG91Y2hlZCgpO1xyXG4gICAgICAgIGlmIChjdXJyZW50U3RhdGUgIT0gdGhpcy50b3VjaGVkKVxyXG4gICAgICAgICAgICB0aGlzLnJ1bkNvbnRyb2xQcm9wQ2hhbmdlRXhwcmVzc2lvbihbVE9VQ0hFRCwgVU5UT1VDSEVEXSlcclxuXHJcbiAgICB9XHJcblxyXG4gICAgbWFya0FzVW50b3VjaGVkKG9wdHM/OiB7XHJcbiAgICAgICAgb25seVNlbGY/OiBib29sZWFuO1xyXG4gICAgfSk6IHZvaWQge1xyXG4gICAgICAgIGxldCBjdXJyZW50U3RhdGUgPSB0aGlzLnVudG91Y2hlZDtcclxuICAgICAgICAvL3N1cGVyLm1hcmtBc1VuVG91Y2hlZCgpO1xyXG4gICAgICAgIC8vc3VwZXIubWFya0FzVW5Ub3VjaGVkKCk7XHJcbiAgICAgICAgaWYgKGN1cnJlbnRTdGF0ZSAhPSB0aGlzLnVudG91Y2hlZClcclxuICAgICAgICAgICAgdGhpcy5ydW5Db250cm9sUHJvcENoYW5nZUV4cHJlc3Npb24oW1VOVE9VQ0hFRCwgVE9VQ0hFRF0pXHJcbiAgICB9XHJcblxyXG4gICAgbWFya0FzRGlydHkob3B0cz86IHtcclxuICAgICAgICBvbmx5U2VsZj86IGJvb2xlYW47XHJcbiAgICB9KTogdm9pZHtcclxuICAgICAgICBsZXQgY3VycmVudFN0YXRlID0gdGhpcy5kaXJ0eTtcclxuICAgICAgICBzdXBlci5tYXJrQXNEaXJ0eSgpO1xyXG4gICAgICAgIGlmKGN1cnJlbnRTdGF0ZSAhPSB0aGlzLmRpcnR5KVxyXG4gICAgICAgICAgICB0aGlzLnJ1bkNvbnRyb2xQcm9wQ2hhbmdlRXhwcmVzc2lvbihbRElSVFldKVxyXG4gICAgfVxyXG5cclxuICAgIG1hcmtBc1ByaXN0aW5lKG9wdHM/OiB7XHJcbiAgICAgICAgb25seVNlbGY/OiBib29sZWFuO1xyXG4gICAgfSk6IHZvaWR7XHJcbiAgICAgICAgbGV0IGN1cnJlbnRTdGF0ZSA9IHRoaXMucHJpc3RpbmU7XHJcbiAgICAgICAgc3VwZXIubWFya0FzRGlydHkoKTtcclxuICAgICAgICBpZihjdXJyZW50U3RhdGUgIT0gdGhpcy5wcmlzdGluZSlcclxuICAgICAgICAgICAgdGhpcy5ydW5Db250cm9sUHJvcENoYW5nZUV4cHJlc3Npb24oW1BSSVNUSU5FXSlcclxuICAgIH1cclxuXHJcblxyXG5cclxuICAgIHJ1bkNvbnRyb2xQcm9wQ2hhbmdlRXhwcmVzc2lvbihwcm9wTmFtZXM6c3RyaW5nW10pe1xyXG4gICAgICAgIHByb3BOYW1lcy5mb3JFYWNoKG5hbWUgPT4ge1xyXG4gICAgICAgICAgICBpZiAoKHRoaXMuX2NvbnRyb2xQcm9wICYmIHRoaXMuX21lc3NhZ2VFeHByZXNzaW9uICYmIHRoaXMuX2NvbnRyb2xQcm9wW25hbWVdKSB8fCAoIXRoaXMuX21lc3NhZ2VFeHByZXNzaW9uICYmIHRoaXMuY2hlY2tFcnJvck1lc3NhZ2VTdHJhdGVneSgpKSlcclxuICAgICAgICAgICAgICAgIHRoaXMuYmluZEVycm9yKCk7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLl9jbGFzc05hbWVDb250cm9sUHJvcCAmJiB0aGlzLl9jbGFzc05hbWVDb250cm9sUHJvcFtuYW1lXSlcclxuICAgICAgICAgICAgICAgIHRoaXMuYmluZENsYXNzTmFtZSgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHJlZnJlc2goKSB7XHJcbiAgICAgICAgdGhpcy5nZXRNZXNzYWdlRXhwcmVzc2lvbig8YW55PnRoaXMucGFyZW50LHRoaXMua2V5TmFtZSk7XHJcbiAgICAgICAgdGhpcy5iaW5kQ29uZGl0aW9uYWxDb250cm9scyhERUNPUkFUT1JTLmRpc2FibGVkLFwiX3JlZkRpc2FibGVDb250cm9sc1wiKTtcclxuICAgICAgICB0aGlzLmJpbmRDb25kaXRpb25hbENvbnRyb2xzKERFQ09SQVRPUlMuZXJyb3IsIFwiX3JlZk1lc3NhZ2VDb250cm9sc1wiKTtcclxuICAgICAgICB0aGlzLmJpbmRDb25kaXRpb25hbENvbnRyb2xzKERFQ09SQVRPUlMuZWxlbWVudENsYXNzLCBcIl9yZWZDbGFzc05hbWVDb250cm9sc1wiKTtcclxuICAgICAgICB0aGlzLmV4ZWN1dGVFeHByZXNzaW9ucygpO1xyXG4gICAgICAgIHRoaXMuYmluZEVycm9yKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmVzZXQodmFsdWU/OiBhbnkpIHtcclxuICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZClcclxuICAgICAgICAgICAgdGhpcy5zZXRWYWx1ZSh2YWx1ZSk7XHJcbiAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICB0aGlzLnNldFZhbHVlKHRoaXMuZ2V0Rm9ybVN0YXRlKHRoaXMuX2Jhc2VWYWx1ZSkpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbW1pdCgpIHtcclxuICAgICAgICB0aGlzLl9iYXNlVmFsdWUgPSB0aGlzLnZhbHVlO1xyXG4gICAgICAgIHRoaXMuY2FsbFBhdGNoKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjYWxsUGF0Y2goKSB7XHJcbiAgICAgICAgdGhpcy5faXNNb2RpZmllZCA9IHRoaXMuZ2V0VmFsdWUodGhpcy5fYmFzZVZhbHVlKSAhPSB0aGlzLmdldFZhbHVlKHRoaXMudmFsdWUpO1xyXG4gICAgICAgIGlmICh0aGlzLnBhcmVudCAmJiB0aGlzLnBhcmVudFtQQVRDSF0pXHJcbiAgICAgICAgICAgIHRoaXMucGFyZW50W1BBVENIXSh0aGlzLmtleU5hbWUpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY2hlY2tFcnJvck1lc3NhZ2VTdHJhdGVneSgpIHtcclxuICAgICAgICBsZXQgaXNCaW5kOiBib29sZWFuID0gdHJ1ZTtcclxuICAgICAgICBzd2l0Y2ggKHRoaXMuX2Vycm9yTWVzc2FnZUJpbmRpbmdTdHJhdGVneSkge1xyXG4gICAgICAgICAgICBjYXNlIEVycm9yTWVzc2FnZUJpbmRpbmdTdHJhdGVneS5PblN1Ym1pdDpcclxuICAgICAgICAgICAgICAgIGlzQmluZCA9ICg8YW55PnRoaXMucGFyZW50KS5zdWJtaXR0ZWQ7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBFcnJvck1lc3NhZ2VCaW5kaW5nU3RyYXRlZ3kuT25EaXJ0eTpcclxuICAgICAgICAgICAgICAgIGlzQmluZCA9IHRoaXMuZGlydHk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBFcnJvck1lc3NhZ2VCaW5kaW5nU3RyYXRlZ3kuT25EaXJ0eU9yU3VibWl0OlxyXG4gICAgICAgICAgICAgICAgaXNCaW5kID0gdGhpcy5kaXJ0eSB8fCAoPGFueT50aGlzLnBhcmVudCkuc3VibWl0dGVkO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICBpc0JpbmQgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gaXNCaW5kO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZXhlY3V0ZUV4cHJlc3Npb25zKCl7XHJcbiAgICAgICAgdGhpcy5wcm9jZXNzRXhwcmVzc2lvbihcIl9yZWZEaXNhYmxlQ29udHJvbHNcIixcImRpc2FibGVkXCIpO1xyXG4gICAgICAgIHRoaXMucHJvY2Vzc0V4cHJlc3Npb24oXCJfcmVmTWVzc2FnZUNvbnRyb2xzXCIsIFwiYmluZEVycm9yXCIpO1xyXG4gICAgICAgIHRoaXMucHJvY2Vzc0V4cHJlc3Npb24oXCJfcmVmQ2xhc3NOYW1lQ29udHJvbHNcIiwgXCJiaW5kQ2xhc3NOYW1lXCIpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0TWVzc2FnZUV4cHJlc3Npb24oZm9ybUdyb3VwOiBJRm9ybUdyb3VwPGFueT4sIGtleU5hbWU6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgICAgIGlmIChmb3JtR3JvdXAgJiYgZm9ybUdyb3VwLm1vZGVsSW5zdGFuY2UpIHtcclxuICAgICAgICAgICAgbGV0IGluc3RhbmNlQ29udGFpbmVyOiBhbnkgPSBkZWZhdWx0Q29udGFpbmVyLmdldChmb3JtR3JvdXAubW9kZWxJbnN0YW5jZS5jb25zdHJ1Y3Rvcik7XHJcbiAgICAgICAgICAgIGlmKGluc3RhbmNlQ29udGFpbmVyKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9tZXNzYWdlRXhwcmVzc2lvbiA9IGluc3RhbmNlQ29udGFpbmVyLm5vblZhbGlkYXRpb25EZWNvcmF0b3JzLmVycm9yLmNvbmRpdGlvbmFsRXhwcmVzc2lvbnNba2V5TmFtZV1cclxuICAgICAgICAgICAgICAgIHRoaXMuX2NvbnRyb2xQcm9wID0gaW5zdGFuY2VDb250YWluZXIubm9uVmFsaWRhdGlvbkRlY29yYXRvcnMuZXJyb3IuY29udHJvbFByb3BbdGhpcy5rZXlOYW1lXTtcclxuICAgICAgICAgICAgICAgIHRoaXMuX2NsYXNzTmFtZUV4cHJlc3Npb24gPSBpbnN0YW5jZUNvbnRhaW5lci5ub25WYWxpZGF0aW9uRGVjb3JhdG9ycy5lbGVtZW50Q2xhc3MuY29uZGl0aW9uYWxFeHByZXNzaW9uc1trZXlOYW1lXTtcclxuICAgICAgICAgICAgICAgIHRoaXMuX2NsYXNzTmFtZUNvbnRyb2xQcm9wID0gaW5zdGFuY2VDb250YWluZXIubm9uVmFsaWRhdGlvbkRlY29yYXRvcnMuZWxlbWVudENsYXNzLmNvbnRyb2xQcm9wW2tleU5hbWVdO1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX2NsYXNzTmFtZUV4cHJlc3Npb24pXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVPbkVsZW1lbnRDbGFzcyA9IHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0U2FuaXRpemVkVmFsdWUodmFsdWU6YW55KSB7XHJcbiAgICAgICAgaWYgKHRoaXMuX3Nhbml0aXplcnMpIHtcclxuICAgICAgICAgICAgZm9yIChsZXQgc2FuaXRpemVyIG9mIHRoaXMuX3Nhbml0aXplcnMpIHtcclxuICAgICAgICAgICAgICAgIHZhbHVlID0gU0FOSVRJWkVSU1tzYW5pdGl6ZXIubmFtZV0odmFsdWUsc2FuaXRpemVyLmNvbmZpZyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYmluZENvbmRpdGlvbmFsQ29udHJvbHMoZGVjb3JhdG9yVHlwZTogc3RyaW5nLCByZWZOYW1lOiBzdHJpbmcpIHtcclxuICAgICAgICBsZXQgX3RoaXMgOmFueT0gdGhpcztcclxuICAgICAgICB0aGlzLl9kaXNhYmxlUHJvdmlkZXIgPSBuZXcgRGlzYWJsZVByb3ZpZGVyKGRlY29yYXRvclR5cGUsdGhpcy5lbnRpdHlPYmplY3QpO1xyXG4gICAgICAgIF90aGlzW3JlZk5hbWVdID0gdGhpcy5fZGlzYWJsZVByb3ZpZGVyLnplcm9Bcmd1bWVudFByb2Nlc3ModGhpcyx0aGlzLmtleU5hbWUpXHJcbiAgICAgICAgdGhpcy5fZGlzYWJsZVByb3ZpZGVyLm9uZUFyZ3VtZW50UHJvY2Vzcyh0aGlzLCBgJHt0aGlzLmtleU5hbWV9JHtSWENPREV9MWApLmZvckVhY2godCA9PiBfdGhpc1tyZWZOYW1lXS5wdXNoKHQpKVxyXG5cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNldENvbnRyb2xFcnJvck1lc3NhZ2VzKCkge1xyXG4gICAgICAgIGlmICgoIXRoaXMuX21lc3NhZ2VFeHByZXNzaW9uICYmIHRoaXMuY2hlY2tFcnJvck1lc3NhZ2VTdHJhdGVneSgpKSB8fCB0aGlzLl9pc1Bhc3NlZEV4cHJlc3Npb24pIHtcclxuICAgICAgICAgICAgdGhpcy5fZXJyb3JNZXNzYWdlcyA9IFtdO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5lcnJvcnMpIHtcclxuICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKHRoaXMuZXJyb3JzKS5mb3JFYWNoKHQgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGFyZW50W0NPTlRST0xTX0VSUk9SXVt0aGlzLmtleU5hbWVdID0gdGhpcy5fZXJyb3JNZXNzYWdlID0gdGhpcy5nZXRFcnJvck1lc3NhZ2UodGhpcy5lcnJvcnMsIHQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5fZXJyb3JNZXNzYWdlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBlcnJvck9iamVjdCA9IE9iamVjdE1ha2VyLnRvSnNvbih0LCB1bmRlZmluZWQsIFt0aGlzLmVycm9yc1t0XVt0XV0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcmVudFtDT05UUk9MU19FUlJPUl1bdGhpcy5rZXlOYW1lXSA9IHRoaXMuX2Vycm9yTWVzc2FnZSA9IHRoaXMuZ2V0RXJyb3JNZXNzYWdlKGVycm9yT2JqZWN0LCB0KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZXJyb3JNZXNzYWdlcy5wdXNoKHRoaXMuX2Vycm9yTWVzc2FnZSk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fZXJyb3JNZXNzYWdlID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5wYXJlbnRbQ09OVFJPTFNfRVJST1JdW3RoaXMua2V5TmFtZV0gPSB1bmRlZmluZWRcclxuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnBhcmVudFtDT05UUk9MU19FUlJPUl1bdGhpcy5rZXlOYW1lXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2Vycm9yTWVzc2FnZXMgPSBbXTtcclxuICAgICAgICAgICAgdGhpcy5fZXJyb3JNZXNzYWdlID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRFcnJvck1lc3NhZ2UoZXJyb3JPYmplY3Q6IHsgW2tleTogc3RyaW5nXTogYW55IH0sIGtleU5hbWU6IHN0cmluZykge1xyXG4gICAgICAgIGlmIChlcnJvck9iamVjdFtrZXlOYW1lXVtNRVNTQUdFXSlcclxuICAgICAgICAgICAgcmV0dXJuIGVycm9yT2JqZWN0W2tleU5hbWVdW01FU1NBR0VdO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcblxyXG5cclxuICAgIHByaXZhdGUgcHJvY2Vzc0V4cHJlc3Npb24ocHJvcE5hbWU6IHN0cmluZywgb3BlcmF0aW9uVHlwZTogc3RyaW5nKSB7XHJcbiAgICAgICAgbGV0IF90aGlzOmFueSA9IHRoaXM7XHJcbiAgICAgICAgaWYgKF90aGlzW3Byb3BOYW1lXSlcclxuICAgICAgICAgICAgZm9yKHZhciBjb250cm9sSW5mbyBvZiBfdGhpc1twcm9wTmFtZV0pe1xyXG4gICAgICAgICAgICAgICAgbGV0IGNvbnRyb2wgPSBjb250cm9sSW5mby5pc1Jvb3QgP0FwcGxpY2F0aW9uVXRpbC5nZXRDb250cm9sKGNvbnRyb2xJbmZvLmNvbnRyb2xQYXRoLEFwcGxpY2F0aW9uVXRpbC5nZXRSb290Rm9ybUdyb3VwKHRoaXMpKSA6IEFwcGxpY2F0aW9uVXRpbC5nZXRGb3JtQ29udHJvbChjb250cm9sSW5mby5jb250cm9sUGF0aCx0aGlzKTtcclxuICAgICAgICAgICAgICAgIGlmKGNvbnRyb2wpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAob3BlcmF0aW9uVHlwZSA9PSBcImRpc2FibGVkXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJlc3VsdCA9IHRoaXMuZXhlY3V0ZUV4cHJlc3Npb24oY29udHJvbEluZm8uY29uZGl0aW9uYWxFeHByZXNzaW9uLCBjb250cm9sKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdClcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2wuZGlzYWJsZSgpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2wuZW5hYmxlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRpb25UeXBlID09IFwiYmluZEVycm9yXCIpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2wuYmluZEVycm9yKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAob3BlcmF0aW9uVHlwZSA9PSBcImJpbmRDbGFzc05hbWVcIilcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbC5iaW5kQ2xhc3NOYW1lKCk7XHJcblxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBleGVjdXRlRXhwcmVzc2lvbihleHByZXNzaW9uOiBGdW5jdGlvbiwgY29udHJvbDogYW55KTogQm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIGV4cHJlc3Npb24uY2FsbChjb250cm9sLnBhcmVudFtNT0RFTF9JTlNUQU5DRV0sIGNvbnRyb2wsIEFwcGxpY2F0aW9uVXRpbC5nZXRQYXJlbnRNb2RlbEluc3RhbmNlVmFsdWUodGhpcyksIGNvbnRyb2wucGFyZW50W01PREVMX0lOU1RBTkNFXSlcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldFZhbHVlKHZhbHVlOiBhbnkpIHtcclxuICAgICAgICByZXR1cm4gdmFsdWUgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPT0gXCJcIiA/IHZhbHVlIDogXCJcIjtcclxuICAgIH1cclxuXHJcbn1cclxuIl19