import { defaultContainer } from '../core/defaultContainer';
import { ARRAY_PROPERTY, OBJECT_PROPERTY, PROPERTY } from "../const";
import { RegexValidator } from '../util/regex-validator';
import { SANITIZERS } from "../util/sanitizers";
import { instanceProvider, getInstance } from "../util/instance-provider.function";
export class BaseFormBuilder {
    constructor() {
    }
    createInstance() {
        let instance = {};
        defaultContainer.modelIncrementCount = defaultContainer.modelIncrementCount + 1;
        let modelName = `RxWebModel${defaultContainer.modelIncrementCount}`;
        instance.constructor = Function(`"use strict";return(function ${modelName}(){ })`)();
        return instance;
    }
    createClassObject(model, formBuilderConfiguration, classInstance) {
        let instanceContainer = defaultContainer.get(model);
        let autoInstanceConfig = formBuilderConfiguration ? formBuilderConfiguration.autoInstanceConfig : undefined;
        if (!autoInstanceConfig) {
            return classInstance && typeof classInstance != "function" ? classInstance : getInstance(model, []);
        }
        else {
            classInstance = classInstance && typeof classInstance != "function" ? classInstance : getInstance(model, autoInstanceConfig.arguments || []);
            if (autoInstanceConfig.objectPropInstanceConfig && autoInstanceConfig.objectPropInstanceConfig.length > 0) {
                autoInstanceConfig.objectPropInstanceConfig.forEach((t) => {
                    let objectProperty = instanceContainer.properties.filter((property) => property.name == t.propertyName && property.propertyType == OBJECT_PROPERTY)[0];
                    if (objectProperty) {
                        let data = classInstance[t.propertyName];
                        classInstance[t.propertyName] = getInstance(objectProperty.entity, t.arguments || []);
                        if (data)
                            this.setObjectValue(data, classInstance[t.propertyName]);
                    }
                });
            }
            if (autoInstanceConfig.arrayPropInstanceConfig && autoInstanceConfig.arrayPropInstanceConfig.length > 0) {
                autoInstanceConfig.arrayPropInstanceConfig.forEach((t) => {
                    let property = instanceContainer.properties.filter((property) => property.name == t.propertyName && property.propertyType == ARRAY_PROPERTY)[0];
                    if (property) {
                        let data = classInstance[t.propertyName];
                        classInstance[t.propertyName] = [];
                        for (var i = 0; i < t.rowItems; i++) {
                            let instance = getInstance(property.entity, t.arguments || []);
                            if (data && data[i])
                                this.setObjectValue(data[i], instance);
                            classInstance[t.propertyName].push(instance);
                        }
                    }
                });
            }
            return classInstance;
        }
    }
    updateObject(model, entityObject, formBuilderConfiguration) {
        let instanceContainer = instanceProvider(model);
        let classInstance = getInstance(model, []);
        if (instanceContainer) {
            instanceContainer.properties.forEach((t) => {
                let entity = ((t.propertyType == OBJECT_PROPERTY || t.propertyType == ARRAY_PROPERTY) && t.entity) ? t.entity : (formBuilderConfiguration && formBuilderConfiguration.genericEntities) ? formBuilderConfiguration.genericEntities[t.name] : undefined;
                if (!entity && t.entityProvider)
                    entity = t.entityProvider.call(entityObject);
                switch (t.propertyType) {
                    case PROPERTY:
                        classInstance[t.name] = this.getValue(entityObject, t, formBuilderConfiguration);
                        break;
                    case OBJECT_PROPERTY:
                        let objectValue = this.getValue(entityObject, t, formBuilderConfiguration);
                        if (objectValue)
                            classInstance[t.name] = this.updateObject(entity, objectValue, formBuilderConfiguration);
                        break;
                    case ARRAY_PROPERTY:
                        let arrayObjectValue = this.getValue(entityObject, t, formBuilderConfiguration);
                        if (arrayObjectValue && Array.isArray(arrayObjectValue)) {
                            classInstance[t.name] = [];
                            for (let row of arrayObjectValue) {
                                let instanceObject = this.updateObject(entity, row, formBuilderConfiguration);
                                classInstance[t.name].push(instanceObject);
                            }
                        }
                        break;
                }
            });
        }
        return classInstance;
    }
    instaceProvider(instanceFunc, entityObject) {
        return instanceProvider(instanceFunc, entityObject);
    }
    getDefaultValue(propertyInfo, value, formBuilderConfiguration) {
        let defaultValue = (formBuilderConfiguration && formBuilderConfiguration.propsConfig && formBuilderConfiguration.propsConfig[propertyInfo.name] && formBuilderConfiguration.propsConfig[propertyInfo.name].defaultValue && !RegexValidator.isNotBlank(value)) ? formBuilderConfiguration.propsConfig[propertyInfo.name].defaultValue : (propertyInfo.defaultValue != undefined && !RegexValidator.isNotBlank(value)) ?
            propertyInfo.defaultValue :
            value;
        return defaultValue;
    }
    sanitizeValue(instanceContainer, propertyName, value, entityObject, baseObject) {
        if (instanceContainer.sanitizers && instanceContainer.sanitizers[propertyName]) {
            for (let sanitizer of instanceContainer.sanitizers[propertyName])
                value = SANITIZERS[sanitizer.name](value, sanitizer.config);
        }
        if (entityObject[propertyName] !== undefined && entityObject[propertyName] !== value)
            entityObject[propertyName] = value;
        if (baseObject[propertyName] !== undefined && baseObject[propertyName] !== value)
            baseObject[propertyName] = value;
        return value;
    }
    getValue(entityObject, propertyInfo, formBuilderConfiguration) {
        let propValue = (propertyInfo.dataPropertyName) ? entityObject[propertyInfo.dataPropertyName] : entityObject[propertyInfo.name];
        return this.getDefaultValue(propertyInfo, propValue, formBuilderConfiguration);
    }
    setObjectValue(entityObject, classInstance) {
        for (var column in entityObject) {
            classInstance[column] = entityObject[column];
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS1mb3JtLWJ1aWxkZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Acnh3ZWIvcmVhY3RpdmUtZm9ybXMvIiwic291cmNlcyI6WyJzZXJ2aWNlcy9iYXNlLWZvcm0tYnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUU1RCxPQUFPLEVBQUUsY0FBYyxFQUFFLGVBQWUsRUFBRSxRQUFRLEVBQUUsTUFBTSxVQUFVLENBQUE7QUFDcEUsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3pELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQTtBQUMvQyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsV0FBVyxFQUFFLE1BQU0sb0NBQW9DLENBQUE7QUFFbEYsTUFBTSxPQUFPLGVBQWU7SUFDeEI7SUFDQSxDQUFDO0lBRVMsY0FBYztRQUNwQixJQUFJLFFBQVEsR0FBRyxFQUFFLENBQUM7UUFDbEIsZ0JBQWdCLENBQUMsbUJBQW1CLEdBQUcsZ0JBQWdCLENBQUMsbUJBQW1CLEdBQUcsQ0FBQyxDQUFDO1FBQ2hGLElBQUksU0FBUyxHQUFHLGFBQWEsZ0JBQWdCLENBQUMsbUJBQW1CLEVBQUUsQ0FBQTtRQUNuRSxRQUFRLENBQUMsV0FBVyxHQUFHLFFBQVEsQ0FBQyxnQ0FBZ0MsU0FBUyxRQUFRLENBQUMsRUFBRSxDQUFBO1FBQ3BGLE9BQU8sUUFBUSxDQUFDO0lBQ3BCLENBQUM7SUFFUyxpQkFBaUIsQ0FBQyxLQUFVLEVBQUUsd0JBQWtELEVBQUUsYUFBbUI7UUFDM0csSUFBSSxpQkFBaUIsR0FBTyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDeEQsSUFBSSxrQkFBa0IsR0FBUSx3QkFBd0IsQ0FBQyxDQUFDLENBQUMsd0JBQXdCLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztRQUNqSCxJQUFJ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Q0FBQyxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2hJLE9BQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQyxZQUFZLEVBQUMsU0FBUyxFQUFDLHdCQUF3QixDQUFDLENBQUM7SUFDakYsQ0FBQztJQUVPLGNBQWMsQ0FBQyxZQUFvQyxFQUFFLGFBQWtCO1FBQzNFLEtBQUssSUFBSSxNQUFNLElBQUksWUFBWSxFQUFFO1lBQzdCLGFBQWEsQ0FBQyxNQUFNLENBQUMsR0FBRyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDaEQ7SUFDTCxDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBGb3JtQnVpbGRlckNvbmZpZ3VyYXRpb24gfSBmcm9tICcuLi9tb2RlbHMvZm9ybS1idWlsZGVyLWNvbmZpZ3VyYXRpb24nXHJcbmltcG9ydCB7IEF1dG9JbnN0YW5jZUNvbmZpZyB9IGZyb20gJy4uL21vZGVscy9pbnRlcmZhY2UvYXV0by1pbnN0YW5jZS1jb25maWcuaW50ZXJmYWNlJ1xyXG5pbXBvcnQgeyBkZWZhdWx0Q29udGFpbmVyIH0gZnJvbSAnLi4vY29yZS9kZWZhdWx0Q29udGFpbmVyJztcclxuaW1wb3J0IHsgSW5zdGFuY2VDb250YWluZXIsUHJvcGVydHlJbmZvfSBmcm9tICcuLi9jb3JlL3ZhbGlkYXRvci5pbnRlcmZhY2UnO1xyXG5pbXBvcnQgeyBBUlJBWV9QUk9QRVJUWSwgT0JKRUNUX1BST1BFUlRZLCBQUk9QRVJUWSB9IGZyb20gXCIuLi9jb25zdFwiXHJcbmltcG9ydCB7IFJlZ2V4VmFsaWRhdG9yIH0gZnJvbSAnLi4vdXRpbC9yZWdleC12YWxpZGF0b3InO1xyXG5pbXBvcnQgeyBTQU5JVElaRVJTIH0gZnJvbSBcIi4uL3V0aWwvc2FuaXRpemVyc1wiXHJcbmltcG9ydCB7IGluc3RhbmNlUHJvdmlkZXIsIGdldEluc3RhbmNlIH0gZnJvbSBcIi4uL3V0aWwvaW5zdGFuY2UtcHJvdmlkZXIuZnVuY3Rpb25cIlxyXG5cclxuZXhwb3J0IGNsYXNzIEJhc2VGb3JtQnVpbGRlciB7XHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgY3JlYXRlSW5zdGFuY2UoKSB7XHJcbiAgICAgICAgbGV0IGluc3RhbmNlID0ge307XHJcbiAgICAgICAgZGVmYXVsdENvbnRhaW5lci5tb2RlbEluY3JlbWVudENvdW50ID0gZGVmYXVsdENvbnRhaW5lci5tb2RlbEluY3JlbWVudENvdW50ICsgMTtcclxuICAgICAgICBsZXQgbW9kZWxOYW1lID0gYFJ4V2ViTW9kZWwke2RlZmF1bHRDb250YWluZXIubW9kZWxJbmNyZW1lbnRDb3VudH1gXHJcbiAgICAgICAgaW5zdGFuY2UuY29uc3RydWN0b3IgPSBGdW5jdGlvbihgXCJ1c2Ugc3RyaWN0XCI7cmV0dXJuKGZ1bmN0aW9uICR7bW9kZWxOYW1lfSgpeyB9KWApKClcclxuICAgICAgICByZXR1cm4gaW5zdGFuY2U7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGNyZWF0ZUNsYXNzT2JqZWN0KG1vZGVsOiBhbnksIGZvcm1CdWlsZGVyQ29uZmlndXJhdGlvbjogRm9ybUJ1aWxkZXJDb25maWd1cmF0aW9uLCBjbGFzc0luc3RhbmNlPzogYW55KSB7XHJcbiAgICAgICAgbGV0IGluc3RhbmNlQ29udGFpbmVyIDphbnk9IGRlZmF1bHRDb250YWluZXIuZ2V0KG1vZGVsKTtcclxuICAgICAgICBsZXQgYXV0b0luc3RhbmNlQ29uZmlnOiBhbnkgPSBmb3JtQnVpbGRlckNvbmZpZ3VyYXRpb24gPyBmb3JtQnVpbGRlckNvbmZpZ3VyYXRpb24uYXV0b0luc3RhbmNlQ29uZmlnIDogdW5kZWZpbmVkO1xyXG4gICAgICAgIGlmICghYXV0b0luc3RhbmNlQ29uZmlnKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBjbGFzc0luc3RhbmNlICYmIHR5cGVvZiBjbGFzc0luc3RhbmNlICE9IFwiZnVuY3Rpb25cIiA/IGNsYXNzSW5zdGFuY2UgOiBnZXRJbnN0YW5jZShtb2RlbCwgW10pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNsYXNzSW5zdGFuY2UgPSBjbGFzc0luc3RhbmNlICYmIHR5cGVvZiBjbGFzc0luc3RhbmNlICE9IFwiZnVuY3Rpb25cIiA/IGNsYXNzSW5zdGFuY2UgOiBnZXRJbnN0YW5jZShtb2RlbCwgYXV0b0luc3RhbmNlQ29uZmlnLmFyZ3VtZW50cyB8fCBbXSlcclxuICAgICAgICAgICAgaWYgKGF1dG9JbnN0YW5jZUNvbmZpZy5vYmplY3RQcm9wSW5zdGFuY2VDb25maWcgJiYgYXV0b0luc3RhbmNlQ29uZmlnLm9iamVjdFByb3BJbnN0YW5jZUNvbmZpZy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBhdXRvSW5zdGFuY2VDb25maWcub2JqZWN0UHJvcEluc3RhbmNlQ29uZmlnLmZvckVhY2goKHQgOmFueSk9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IG9iamVjdFByb3BlcnR5ID0gaW5zdGFuY2VDb250YWluZXIucHJvcGVydGllcy5maWx0ZXIoKHByb3BlcnR5IDphbnkpPT4gcHJvcGVydHkubmFtZSA9PSB0LnByb3BlcnR5TmFtZSAmJiBwcm9wZXJ0eS5wcm9wZXJ0eVR5cGUgPT0gT0JKRUNUX1BST1BFUlRZKVswXTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAob2JqZWN0UHJvcGVydHkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGRhdGEgPWNsYXNzSW5zdGFuY2VbdC5wcm9wZXJ0eU5hbWVdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjbGFzc0luc3RhbmNlW3QucHJvcGVydHlOYW1lXSA9IGdldEluc3RhbmNlKG9iamVjdFByb3BlcnR5LmVudGl0eSwgdC5hcmd1bWVudHMgfHwgW10pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0T2JqZWN0VmFsdWUoZGF0YSwgY2xhc3NJbnN0YW5jZVt0LnByb3BlcnR5TmFtZV0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGF1dG9JbnN0YW5jZUNvbmZpZy5hcnJheVByb3BJbnN0YW5jZUNvbmZpZyAmJiBhdXRvSW5zdGFuY2VDb25maWcuYXJyYXlQcm9wSW5zdGFuY2VDb25maWcubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgYXV0b0luc3RhbmNlQ29uZmlnLmFycmF5UHJvcEluc3RhbmNlQ29uZmlnLmZvckVhY2goKHQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBwcm9wZXJ0eSA9IGluc3RhbmNlQ29udGFpbmVyLnByb3BlcnRpZXMuZmlsdGVyKChwcm9wZXJ0eTogYW55KSA9PiBwcm9wZXJ0eS5uYW1lID09IHQucHJvcGVydHlOYW1lICYmIHByb3BlcnR5LnByb3BlcnR5VHlwZSA9PSBBUlJBWV9QUk9QRVJUWSlbMF07XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBkYXRhID0gY2xhc3NJbnN0YW5jZVt0LnByb3BlcnR5TmFtZV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzSW5zdGFuY2VbdC5wcm9wZXJ0eU5hbWVdID0gW107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdC5yb3dJdGVtczsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgaW5zdGFuY2UgPSBnZXRJbnN0YW5jZShwcm9wZXJ0eS5lbnRpdHksIHQuYXJndW1lbnRzIHx8IFtdKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXRhICYmIGRhdGFbaV0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRPYmplY3RWYWx1ZShkYXRhW2ldLCBpbnN0YW5jZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzc0luc3RhbmNlW3QucHJvcGVydHlOYW1lXS5wdXNoKGluc3RhbmNlKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gY2xhc3NJbnN0YW5jZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIHVwZGF0ZU9iamVjdChtb2RlbDogYW55LCBlbnRpdHlPYmplY3Q6IGFueSwgZm9ybUJ1aWxkZXJDb25maWd1cmF0aW9uPzogRm9ybUJ1aWxkZXJDb25maWd1cmF0aW9uKSB7XHJcbiAgICAgICAgbGV0IGluc3RhbmNlQ29udGFpbmVyOmFueSA9IGluc3RhbmNlUHJvdmlkZXIobW9kZWwpO1xyXG4gICAgICAgIGxldCBjbGFzc0luc3RhbmNlID0gZ2V0SW5zdGFuY2UobW9kZWwsIFtdKTtcclxuICAgICAgICBpZiAoaW5zdGFuY2VDb250YWluZXIpIHtcclxuICAgICAgICAgICAgaW5zdGFuY2VDb250YWluZXIucHJvcGVydGllcy5mb3JFYWNoKCh0IDphbnkpPT4ge1xyXG4gICAgICAgICAgICAgICAgbGV0IGVudGl0eSA9ICgodC5wcm9wZXJ0eVR5cGUgPT0gT0JKRUNUX1BST1BFUlRZIHx8IHQucHJvcGVydHlUeXBlID09IEFSUkFZX1BST1BFUlRZKSAmJiB0LmVudGl0eSkgPyB0LmVudGl0eSA6IChmb3JtQnVpbGRlckNvbmZpZ3VyYXRpb24gJiYgZm9ybUJ1aWxkZXJDb25maWd1cmF0aW9uLmdlbmVyaWNFbnRpdGllcykgPyBmb3JtQnVpbGRlckNvbmZpZ3VyYXRpb24uZ2VuZXJpY0VudGl0aWVzW3QubmFtZV0gOiB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWVudGl0eSAmJiB0LmVudGl0eVByb3ZpZGVyKVxyXG4gICAgICAgICAgICAgICAgICAgIGVudGl0eSA9IHQuZW50aXR5UHJvdmlkZXIuY2FsbChlbnRpdHlPYmplY3QpO1xyXG4gICAgICAgICAgICAgICAgc3dpdGNoICh0LnByb3BlcnR5VHlwZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgUFJPUEVSVFk6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzSW5zdGFuY2VbdC5uYW1lXSA9IHRoaXMuZ2V0VmFsdWUoZW50aXR5T2JqZWN0LCB0LCBmb3JtQnVpbGRlckNvbmZpZ3VyYXRpb24pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgT0JKRUNUX1BST1BFUlRZOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgb2JqZWN0VmFsdWUgPSB0aGlzLmdldFZhbHVlKGVudGl0eU9iamVjdCwgdCwgZm9ybUJ1aWxkZXJDb25maWd1cmF0aW9uKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9iamVjdFZhbHVlKSBcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzSW5zdGFuY2VbdC5uYW1lXSA9IHRoaXMudXBkYXRlT2JqZWN0KGVudGl0eSwgb2JqZWN0VmFsdWUsIGZvcm1CdWlsZGVyQ29uZmlndXJhdGlvbilcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBBUlJBWV9QUk9QRVJUWTpcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGFycmF5T2JqZWN0VmFsdWUgPSB0aGlzLmdldFZhbHVlKGVudGl0eU9iamVjdCwgdCwgZm9ybUJ1aWxkZXJDb25maWd1cmF0aW9uKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFycmF5T2JqZWN0VmFsdWUgJiYgQXJyYXkuaXNBcnJheShhcnJheU9iamVjdFZhbHVlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NJbnN0YW5jZVt0Lm5hbWVdID0gW107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCByb3cgb2YgYXJyYXlPYmplY3RWYWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpbnN0YW5jZU9iamVjdCA9IHRoaXMudXBkYXRlT2JqZWN0KGVudGl0eSwgcm93LCBmb3JtQnVpbGRlckNvbmZpZ3VyYXRpb24pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NJbnN0YW5jZVt0Lm5hbWVdLnB1c2goaW5zdGFuY2VPYmplY3QpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gY2xhc3NJbnN0YW5jZTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgcHJvdGVjdGVkIGluc3RhY2VQcm92aWRlcihpbnN0YW5jZUZ1bmM6IGFueSwgZW50aXR5T2JqZWN0OiBhbnkpOiBJbnN0YW5jZUNvbnRhaW5lciB7XHJcbiAgICAgICAgcmV0dXJuIGluc3RhbmNlUHJvdmlkZXIoaW5zdGFuY2VGdW5jLCBlbnRpdHlPYmplY3QpO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBnZXREZWZhdWx0VmFsdWUocHJvcGVydHlJbmZvOiBQcm9wZXJ0eUluZm8sIHZhbHVlOiBhbnksIGZvcm1CdWlsZGVyQ29uZmlndXJhdGlvbjogRm9ybUJ1aWxkZXJDb25maWd1cmF0aW9uKSB7XHJcbiAgICAgICAgbGV0IGRlZmF1bHRWYWx1ZSA9IChmb3JtQnVpbGRlckNvbmZpZ3VyYXRpb24gJiYgZm9ybUJ1aWxkZXJDb25maWd1cmF0aW9uLnByb3BzQ29uZmlnICYmIGZvcm1CdWlsZGVyQ29uZmlndXJhdGlvbi5wcm9wc0NvbmZpZ1twcm9wZXJ0eUluZm8ubmFtZV0gJiYgZm9ybUJ1aWxkZXJDb25maWd1cmF0aW9uLnByb3BzQ29uZmlnW3Byb3BlcnR5SW5mby5uYW1lXS5kZWZhdWx0VmFsdWUgJiYgIVJlZ2V4VmFsaWRhdG9yLmlzTm90QmxhbmsodmFsdWUpKSA/IGZvcm1CdWlsZGVyQ29uZmlndXJhdGlvbi5wcm9wc0NvbmZpZ1twcm9wZXJ0eUluZm8ubmFtZV0uZGVmYXVsdFZhbHVlIDogKHByb3BlcnR5SW5mby5kZWZhdWx0VmFsdWUgIT0gdW5kZWZpbmVkICYmICFSZWdleFZhbGlkYXRvci5pc05vdEJsYW5rKHZhbHVlKSkgP1xyXG4gICAgICAgICAgICBwcm9wZXJ0eUluZm8uZGVmYXVsdFZhbHVlIDpcclxuICAgICAgICAgICAgdmFsdWVcclxuICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBzYW5pdGl6ZVZhbHVlKGluc3RhbmNlQ29udGFpbmVyOiBJbnN0YW5jZUNvbnRhaW5lciwgcHJvcGVydHlOYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnksIGVudGl0eU9iamVjdDogYW55LCBiYXNlT2JqZWN0OiBhbnkpIHtcclxuICAgICAgICBpZiAoaW5zdGFuY2VDb250YWluZXIuc2FuaXRpemVycyAmJiBpbnN0YW5jZUNvbnRhaW5lci5zYW5pdGl6ZXJzW3Byb3BlcnR5TmFtZV0pIHtcclxuICAgICAgICAgICAgZm9yIChsZXQgc2FuaXRpemVyIG9mIGluc3RhbmNlQ29udGFpbmVyLnNhbml0aXplcnNbcHJvcGVydHlOYW1lXSlcclxuICAgICAgICAgICAgICAgIHZhbHVlID0gU0FOSVRJWkVSU1tzYW5pdGl6ZXIubmFtZV0odmFsdWUsc2FuaXRpemVyLmNvbmZpZyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChlbnRpdHlPYmplY3RbcHJvcGVydHlOYW1lXSAhPT0gdW5kZWZpbmVkICYmIGVudGl0eU9iamVjdFtwcm9wZXJ0eU5hbWVdICE9PSB2YWx1ZSlcclxuICAgICAgICAgICAgZW50aXR5T2JqZWN0W3Byb3BlcnR5TmFtZV0gPSB2YWx1ZTtcclxuICAgICAgICBpZiAoYmFzZU9iamVjdFtwcm9wZXJ0eU5hbWVdICE9PSB1bmRlZmluZWQgJiYgYmFzZU9iamVjdFtwcm9wZXJ0eU5hbWVdICE9PSB2YWx1ZSlcclxuICAgICAgICAgICAgYmFzZU9iamVjdFtwcm9wZXJ0eU5hbWVdID0gdmFsdWU7XHJcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0VmFsdWUoZW50aXR5T2JqZWN0OiB7IFtrZXk6IHN0cmluZ106IGFueSB9LCBwcm9wZXJ0eUluZm86IFByb3BlcnR5SW5mbywgZm9ybUJ1aWxkZXJDb25maWd1cmF0aW9uPzogRm9ybUJ1aWxkZXJDb25maWd1cmF0aW9uKSB7XHJcbiAgICAgICAgbGV0IHByb3BWYWx1ZSA9IChwcm9wZXJ0eUluZm8uZGF0YVByb3BlcnR5TmFtZSkgPyBlbnRpdHlPYmplY3RbcHJvcGVydHlJbmZvLmRhdGFQcm9wZXJ0eU5hbWVdIDogZW50aXR5T2JqZWN0W3Byb3BlcnR5SW5mby5uYW1lXTtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXREZWZhdWx0VmFsdWUocHJvcGVydHlJbmZvLHByb3BWYWx1ZSxmb3JtQnVpbGRlckNvbmZpZ3VyYXRpb24pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2V0T2JqZWN0VmFsdWUoZW50aXR5T2JqZWN0OiB7IFtrZXk6IHN0cmluZ106IGFueSB9LCBjbGFzc0luc3RhbmNlOiBhbnkpIHtcclxuICAgICAgICBmb3IgKHZhciBjb2x1bW4gaW4gZW50aXR5T2JqZWN0KSB7XHJcbiAgICAgICAgICAgIGNsYXNzSW5zdGFuY2VbY29sdW1uXSA9IGVudGl0eU9iamVjdFtjb2x1bW5dO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG4iXX0=