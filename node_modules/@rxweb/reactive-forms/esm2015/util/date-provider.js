import { ReactiveFormConfig } from "./reactive-form-config";
import { ApplicationUtil } from './app-util';
const ISO_DATE_REGEX = /^(\d{4}-\d{1,2}-\d{1,2})$/;
export class DateProvider {
    isDate(value) {
        return value instanceof Date && !isNaN(value.valueOf());
    }
    getRegex(dateFormat) {
        var regExp;
        switch (dateFormat) {
            case 'ymd':
                regExp = "^(?:[0-9]{4})-(1[0-2]|0?[1-9])-(3[01]|[12][0-9]|0?[1-9])$";
                break;
            case 'dmy':
                regExp = "^(3[01]|[12][0-9]|0?[1-9])-(1[0-2]|0?[1-9])-(?:[0-9]{2})?[0-9]{2}$";
                break;
            case 'mdy':
                regExp = "^(1[0-2]|0?[1-9])-(3[01]|[12][0-9]|0?[1-9])-(?:[0-9]{2})?[0-9]{2}$";
                break;
        }
        return new RegExp(regExp);
    }
    regex() {
        var regExp;
        if (ReactiveFormConfig && ReactiveFormConfig.json && ReactiveFormConfig.json.internationalization && ReactiveFormConfig.json.internationalization.dateFormat && ReactiveFormConfig.json.internationalization.seperator)
            regExp = this.getRegex(ReactiveFormConfig.json.internationalization.dateFormat);
        else
            regExp = (ReactiveFormConfig && ReactiveFormConfig.json && ReactiveFormConfig.json.baseConfig && ReactiveFormConfig.json.baseConfig.dateFormat) ? this.getRegex(ReactiveFormConfig.json.baseConfig.dateFormat) : this.getRegex("mdy");
        return regExp;
    }
    getDate(value, isBaseFormat = false) {
        let year, month, day;
        if (!this.isDate(value)) {
            let seperator;
            let dateFormat;
            if (ISO_DATE_REGEX.test(value)) {
                seperator = "-";
                dateFormat = "ymd";
            }
            else {
                seperator = ReactiveFormConfig && ReactiveFormConfig.json && ReactiveFormConfig.json.baseConfig && ReactiveFormConfig.json.baseConfig.seperator ? ReactiveFormConfig.json.baseConfig.seperator : "/";
                dateFormat = ReactiveFormConfig && ReactiveFormConfig.json && ReactiveFormConfig.json.baseConfig && ReactiveFormConfig.json.baseConfig.dateFormat ? ReactiveFormConfig.json.baseConfig.dateFormat : "mdy";
            }
            if (!isBaseFormat && ReactiveFormConfig && ReactiveFormConfig.json && ReactiveFormConfig.json.internationalization && ReactiveFormConfig.json.internationalization.dateFormat && ReactiveFormConfig.json.internationalization.seperator) {
                seperator = ReactiveFormConfig.json.internationalization.seperator;
                dateFormat = ReactiveFormConfig.json.internationalization.dateFormat;
            }
            switch (dateFormat) {
                case 'ymd':
                    [year, month, day] = value.split(seperator).map((val) => +val);
                    break;
                case 'dmy':
                    [day, month, year] = value.split(seperator).map((val) => +val);
                    break;
                case 'mdy':
                    [month, day, year] = value.split(seperator).map((val) => +val);
                    break;
            }
            return new Date(year, month - 1, day);
        }
        else
            return value;
    }
    isValid(value) {
        if (typeof value == "string") {
            if (ISO_DATE_REGEX.test(value))
                return true;
            let seperator = '/';
            if (ReactiveFormConfig.json && ReactiveFormConfig.json.internationalization && ReactiveFormConfig.json.internationalization.seperator)
                seperator = ReactiveFormConfig.json.internationalization.seperator;
            value = value.replace(seperator, '-').replace(seperator, '-');
            return this.regex().test(value);
        }
        else
            return this.isDate(value);
    }
    getConfigDateValue(config) {
        let date = config.value;
        if (config.value && typeof config.value == "string") {
            date = this.getDate(config.value, true);
        }
        return date;
    }
    getCompareDate(config, control) {
        let date = this.getConfigDateValue(config);
        if (config.fieldName) {
            let checkControl = ApplicationUtil.getFormControl(config.fieldName, control);
            if (checkControl && checkControl.value) {
                date = this.getDate(checkControl.value);
            }
        }
        return date;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZS1wcm92aWRlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0ByeHdlYi9yZWFjdGl2ZS1mb3Jtcy8iLCJzb3VyY2VzIjpbInV0aWwvZGF0ZS1wcm92aWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUM1RCxPQUFPLEVBQUMsZUFBZSxFQUFFLE1BQU0sWUFBWSxDQUFBO0FBQzNDLE1BQU0sY0FBYyxHQUFHLDJCQUEyQixDQUFDO0FBQ25ELE1BQU0sT0FBTyxZQUFZO0lBRXZCLE1BQU0sQ0FBQyxLQUFVO1FBQ2YsT0FBTyxLQUFLLFlBQVksSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO0lBQzFELENBQUM7SUFFUyxRQUFRLENBQUMsVUFBaUI7UUFDaEMsSUFBSSxNQUFhLENBQUM7UUFDbEIsUUFBTyxVQUFVLEVBQUM7WUFDWixLQUFLLEtBQUs7Z0JBQ1YsTUFBTSxHQUFHLDJEQUEyRCxDQUFDO2dCQUNyRSxNQUFNO1lBQ04sS0FBSyxLQUFLO2dCQUNWLE1BQU0sR0FBRyxvRUFBb0UsQ0FBQztnQkFDOUUsTUFBTTtZQUNOLEtBQUssS0FBSztnQkFDVixNQUFNLEdBQUcsb0VBQW9FLENBQUM7Z0JBQzlFLE1BQU07U0FDWDtRQUNELE9BQU8sSUFBSSxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDNUIsQ0FBQztJQUVELEtBQUs7UUFDSCxJQUFJLE1BQWEsQ0FBQztRQUNsQixJQUFHLGtCQUFrQixJQUFJLGtCQUFrQixDQUFDLElBQUksSUFBSSxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLElBQUksa0JBQWtCLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFVBQVUsSUFBSyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsU0FBUztZQUNwTixNQUFNLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxr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Q0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUEsY0FBYyxDQUFDLE1BQVUsRUFBQyxPQUFXO1FBQzlCLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMzQyxJQUFHLE1BQU0sQ0FBQyxTQUFTLEVBQUM7WUFDbEIsSUFBSSxZQUFZLEdBQVMsZUFBZSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ2hGLElBQUcsWUFBWSxJQUFJLFlBQVksQ0FBQyxLQUFLLEVBQUM7Z0JBQ2xDLElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQTthQUN0QztTQUNGO1FBQ1QsT0FBTyxJQUFJLENBQUM7SUFDbEIsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVhY3RpdmVGb3JtQ29uZmlnIH0gZnJvbSBcIi4vcmVhY3RpdmUtZm9ybS1jb25maWdcIjtcclxuaW1wb3J0IHtBcHBsaWNhdGlvblV0aWwgfSBmcm9tICcuL2FwcC11dGlsJ1xyXG5jb25zdCBJU09fREFURV9SRUdFWCA9IC9eKFxcZHs0fS1cXGR7MSwyfS1cXGR7MSwyfSkkLztcclxuZXhwb3J0IGNsYXNzIERhdGVQcm92aWRlcntcclxuXHJcbiAgaXNEYXRlKHZhbHVlOiBhbnkpOiBCb29sZWFuIHtcclxuICAgIHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHZhbHVlLnZhbHVlT2YoKSk7XHJcbiAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0UmVnZXgoZGF0ZUZvcm1hdDpzdHJpbmcpIDogUmVnRXhwe1xyXG4gICAgICB2YXIgcmVnRXhwOnN0cmluZztcclxuICAgICAgc3dpdGNoKGRhdGVGb3JtYXQpe1xyXG4gICAgICAgICAgICBjYXNlICd5bWQnOlxyXG4gICAgICAgICAgICByZWdFeHAgPSBcIl4oPzpbMC05XXs0fSktKDFbMC0yXXwwP1sxLTldKS0oM1swMV18WzEyXVswLTldfDA/WzEtOV0pJFwiO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnZG15JzpcclxuICAgICAgICAgICAgcmVnRXhwID0gXCJeKDNbMDFdfFsxMl1bMC05XXwwP1sxLTldKS0oMVswLTJdfDA/WzEtOV0pLSg/OlswLTldezJ9KT9bMC05XXsyfSRcIjtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ21keSc6XHJcbiAgICAgICAgICAgIHJlZ0V4cCA9IFwiXigxWzAtMl18MD9bMS05XSktKDNbMDFdfFsxMl1bMC05XXwwP1sxLTldKS0oPzpbMC05XXsyfSk/WzAtOV17Mn0kXCI7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBuZXcgUmVnRXhwKHJlZ0V4cCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmVnZXgoKXtcclxuICAgICAgdmFyIHJlZ0V4cDpSZWdFeHA7XHJcbiAgICAgIGlmKFJlYWN0aXZlRm9ybUNvbmZpZyAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbiAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5pbnRlcm5hdGlvbmFsaXphdGlvbiAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5pbnRlcm5hdGlvbmFsaXphdGlvbi5kYXRlRm9ybWF0ICAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5pbnRlcm5hdGlvbmFsaXphdGlvbi5zZXBlcmF0b3IpXHJcbiAgICAgICAgcmVnRXhwID0gdGhpcy5nZXRSZWdleChSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5pbnRlcm5hdGlvbmFsaXphdGlvbi5kYXRlRm9ybWF0KVxyXG4gICAgICBlbHNlXHJcbiAgICAgICAgcmVnRXhwID0gKFJlYWN0aXZlRm9ybUNvbmZpZyAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbiAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5iYXNlQ29uZmlnICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmJhc2VDb25maWcuZGF0ZUZvcm1hdCkgPyB0aGlzLmdldFJlZ2V4KFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmJhc2VDb25maWcuZGF0ZUZvcm1hdCkgOiB0aGlzLmdldFJlZ2V4KFwibWR5XCIpO1xyXG4gICAgICByZXR1cm4gcmVnRXhwO1xyXG4gICAgfVxyXG5cclxuICBnZXREYXRlKHZhbHVlOnN0cmluZyB8IERhdGUsaXNCYXNlRm9ybWF0OmJvb2xlYW4gPSBmYWxzZSk6IERhdGV7XHJcbiAgICBsZXQgeWVhcjphbnksbW9udGg6YW55LGRheTphbnk7XHJcbiAgICBpZighdGhpcy5pc0RhdGUodmFsdWUpKXtcclxuICAgICAgbGV0IHNlcGVyYXRvcjpzdHJpbmc7XHJcbiAgICAgIGxldCBkYXRlRm9ybWF0OnN0cmluZztcclxuICAgICAgaWYoSVNPX0RBVEVfUkVHRVgudGVzdCg8c3RyaW5nPnZhbHVlKSl7XHJcbiAgICAgICAgc2VwZXJhdG9yID0gXCItXCI7XHJcbiAgICAgICAgZGF0ZUZvcm1hdCA9IFwieW1kXCJcclxuICAgICAgfWVsc2V7XHJcbiAgICAgICAgc2VwZXJhdG9yID0gUmVhY3RpdmVGb3JtQ29uZmlnICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmJhc2VDb25maWcgJiYgUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uYmFzZUNvbmZpZy5zZXBlcmF0b3IgPyBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5iYXNlQ29uZmlnLnNlcGVyYXRvciA6IFwiL1wiO1xyXG4gICAgICAgIGRhdGVGb3JtYXQgPSBSZWFjdGl2ZUZvcm1Db25maWcgJiYgUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24gJiYgUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uYmFzZUNvbmZpZyAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5iYXNlQ29uZmlnLmRhdGVGb3JtYXQgPyBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5iYXNlQ29uZmlnLmRhdGVGb3JtYXQgOiBcIm1keVwiO1xyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICBpZighaXNCYXNlRm9ybWF0ICYmIFJlYWN0aXZlRm9ybUNvbmZpZyAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbiAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5pbnRlcm5hdGlvbmFsaXphdGlvbiAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5pbnRlcm5hdGlvbmFsaXphdGlvbi5kYXRlRm9ybWF0ICAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5pbnRlcm5hdGlvbmFsaXphdGlvbi5zZXBlcmF0b3IpXHJcbiAgICAgIHtcclxuICAgICAgICBzZXBlcmF0b3IgPSBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5pbnRlcm5hdGlvbmFsaXphdGlvbi5zZXBlcmF0b3I7XHJcbiAgICAgICAgZGF0ZUZvcm1hdCA9IFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmludGVybmF0aW9uYWxpemF0aW9uLmRhdGVGb3JtYXQ7XHJcbiAgICAgIH1cclxuICAgICAgICBzd2l0Y2goZGF0ZUZvcm1hdCl7XHJcbiAgICAgICAgICAgIGNhc2UgJ3ltZCc6XHJcbiAgICAgICAgICAgIFt5ZWFyLCBtb250aCwgZGF5XSA9ICg8U3RyaW5nPnZhbHVlKS5zcGxpdChzZXBlcmF0b3IpLm1hcCgodmFsOiBzdHJpbmcpID0+ICt2YWwpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnZG15JzpcclxuICAgICAgICAgICAgW2RheSxtb250aCx5ZWFyXSA9ICg8U3RyaW5nPnZhbHVlKS5zcGxpdChzZXBlcmF0b3IpLm1hcCgodmFsOiBzdHJpbmcpID0+ICt2YWwpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnbWR5JzpcclxuICAgICAgICAgICAgW21vbnRoLGRheSx5ZWFyXSA9ICg8U3RyaW5nPnZhbHVlKS5zcGxpdChzZXBlcmF0b3IpLm1hcCgodmFsOiBzdHJpbmcpID0+ICt2YWwpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBuZXcgRGF0ZSh5ZWFyLG1vbnRoLTEsZGF5KTtcclxuICAgIH1lbHNlXHJcbiAgICAgIHJldHVybiA8RGF0ZT52YWx1ZTtcclxuICB9XHJcblxyXG4gIGlzVmFsaWQodmFsdWU6c3RyaW5nIHwgRGF0ZSkgOiBCb29sZWFue1xyXG4gICAgaWYodHlwZW9mIHZhbHVlID09IFwic3RyaW5nXCIpe1xyXG4gICAgICBpZihJU09fREFURV9SRUdFWC50ZXN0KDxzdHJpbmc+dmFsdWUpKVxyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICBsZXQgc2VwZXJhdG9yID0gJy8nXHJcbiAgICAgIGlmKFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmludGVybmF0aW9uYWxpemF0aW9uICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmludGVybmF0aW9uYWxpemF0aW9uLnNlcGVyYXRvcilcclxuICAgICAgICBzZXBlcmF0b3IgPSBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5pbnRlcm5hdGlvbmFsaXphdGlvbi5zZXBlcmF0b3I7XHJcbiAgICAgIHZhbHVlID0gdmFsdWUucmVwbGFjZShzZXBlcmF0b3IsJy0nKS5yZXBsYWNlKHNlcGVyYXRvciwnLScpO1xyXG4gICAgICByZXR1cm4gdGhpcy5yZWdleCgpLnRlc3QodmFsdWUpO1xyXG4gICAgfWVsc2VcclxuICAgICAgcmV0dXJuIHRoaXMuaXNEYXRlKHZhbHVlKTtcclxuICB9XHJcblxyXG4gIGdldENvbmZpZ0RhdGVWYWx1ZShjb25maWc6YW55KXtcclxuICAgIGxldCBkYXRlID0gY29uZmlnLnZhbHVlO1xyXG4gICAgaWYoY29uZmlnLnZhbHVlICYmIHR5cGVvZiBjb25maWcudmFsdWUgPT0gXCJzdHJpbmdcIil7XHJcbiAgICAgIGRhdGUgPSB0aGlzLmdldERhdGUoY29uZmlnLnZhbHVlLHRydWUpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGRhdGU7XHJcbiAgfVxyXG5cclxuICAgZ2V0Q29tcGFyZURhdGUoY29uZmlnOmFueSxjb250cm9sOmFueSl7XHJcbiAgICAgICAgICBsZXQgZGF0ZSA9IHRoaXMuZ2V0Q29uZmlnRGF0ZVZhbHVlKGNvbmZpZyk7XHJcbiAgICAgICAgICBpZihjb25maWcuZmllbGROYW1lKXtcclxuICAgICAgICAgICAgbGV0IGNoZWNrQ29udHJvbCA6IGFueSA9IEFwcGxpY2F0aW9uVXRpbC5nZXRGb3JtQ29udHJvbChjb25maWcuZmllbGROYW1lLGNvbnRyb2wpO1xyXG4gICAgICAgICAgICAgIGlmKGNoZWNrQ29udHJvbCAmJiBjaGVja0NvbnRyb2wudmFsdWUpe1xyXG4gICAgICAgICAgICAgICAgICBkYXRlID0gdGhpcy5nZXREYXRlKGNoZWNrQ29udHJvbC52YWx1ZSlcclxuICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBkYXRlO1xyXG4gIH1cclxufVxyXG4iXX0=