import { RegexValidator } from "../util/regex-validator";
import { ObjectMaker } from "../util/object-maker";
import { getConfigObject } from "../util/config-provider";
import { AnnotationTypes } from "../core/validator.static";
import { FormProvider } from '../util/form-provider';
import { checkLength } from '../util/check-length';
import { calculate } from '../algorithm/luhn-algorithm';
export function creditCardValidator(configModel) {
    let cardDigits = {
        AmericanExpress: [15],
        DinersClub: [14, 16, 19],
        Discover: [16, 19],
        JCB: [16, 19],
        Maestro: [12, 16, 19],
        MasterCard: [16],
        Visa: [13, 16, 19]
    };
    function validate(creditCardNumber) {
        var digit = parseInt(creditCardNumber.substring(creditCardNumber.length - 1, creditCardNumber.length));
        return calculate(creditCardNumber.substring(0, creditCardNumber.length - 1)) == parseInt(String(digit)) ? !0 : !1;
    }
    function getCardProviderName(cardNumber) {
        var cardProviderName = "";
        return /^(5018|5020|5038|5612|5893|6304|6759|6761|6762|6763|0604|6390)\d+$/.test(cardNumber) ? cardProviderName = "Maestro" : /^5[1-5]/.test(cardNumber) ? cardProviderName = "MasterCard" : /^4/.test(cardNumber) ? cardProviderName = "Visa" : /^3[47]/.test(cardNumber) ? cardProviderName = "AmericanExpress" : /^(?:2131|1800|35)/.test(cardNumber) ? cardProviderName = "JCB" : /^3(?:0[0-5]|[68])/.test(cardNumber) ? cardProviderName = "DinersClub" : /^6(?:011|5)/.test(cardNumber) && (cardProviderName = "Discover"), cardProviderName;
    }
    return (control) => {
        const controlValue = control.value;
        let config = getConfigObject(configModel, control);
        const parentObject = (control.parent) ? control.parent.value : undefined;
        if (FormProvider.ProcessRule(control, config)) {
            if (RegexValidator.isNotBlank(controlValue)) {
                let isValid = false;
                let cardTypes = config.fieldName && parentObject[config.fieldName] ? [parentObject[config.fieldName]] : config.creditCardTypes;
                let cardType = '';
                for (let creditCardType of cardTypes) {
                    isValid = checkLength(controlValue.length, cardDigits[creditCardType]) && getCardProviderName(controlValue) == creditCardType && validate(controlValue);
                    cardType = creditCardType;
                    if (isValid)
                        break;
                }
                if (!isValid)
                    return ObjectMaker.toJson(AnnotationTypes.creditCard, config, [controlValue, cardType]);
            }
        }
        return ObjectMaker.null();
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlZGl0LWNhcmQudmFsaWRhdG9yLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHJ4d2ViL3JlYWN0aXZlLWZvcm1zLyIsInNvdXJjZXMiOlsicmVhY3RpdmUtZm9ybS12YWxpZGF0b3JzL2NyZWRpdC1jYXJkLnZhbGlkYXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFHQSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDekQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRW5ELE9BQU8sRUFBQyxlQUFlLEVBQUMsTUFBTSx5QkFBeUIsQ0FBQTtBQUN2RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDM0QsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ3JELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQTtBQUNsRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sNkJBQTZCLENBQUE7QUFFdkQsTUFBTSxVQUFVLG1CQUFtQixDQUFDLFdBQTZCO0lBQzdELElBQUksVUFBVSxHQUFnQztRQUMxQyxlQUFlLEVBQUUsQ0FBQyxFQUFFLENBQUM7UUFDckIsVUFBVSxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUM7UUFDeEIsUUFBUSxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQztRQUNsQixHQUFHLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDO1FBQ2IsT0FBTyxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUM7UUFDckIsVUFBVSxFQUFFLENBQUMsRUFBRSxDQUFDO1FBQ2hCLElBQUksRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDO0tBQ3JCLENBQUE7SUFDRCxTQUFTLFFBQVEsQ0FBQyxnQkFBd0I7UUFDdEMsSUFBSSxLQUFLLEdBQUcsUUFBUSxDQUFDLGdC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Q0FBQyxZQUFZLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQTthQUM5RjtTQUNKO1FBQ0QsT0FBTyxXQUFXLENBQUMsSUFBSSxFQUFFLENBQUM7SUFFOUIsQ0FBQyxDQUFBO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFic3RyYWN0Q29udHJvbCB9IGZyb20gXCIuLi9hYnN0cmFjdC9hYnN0cmFjdC1jb250cm9sXCJcclxuaW1wb3J0IHsgVmFsaWRhdG9yRm4gfSBmcm9tICcuLi9tb2RlbHMvaW50ZXJmYWNlL3ZhbGlkYXRvci1mbidcclxuXHJcbmltcG9ydCB7IFJlZ2V4VmFsaWRhdG9yIH0gZnJvbSBcIi4uL3V0aWwvcmVnZXgtdmFsaWRhdG9yXCI7XHJcbmltcG9ydCB7IE9iamVjdE1ha2VyIH0gZnJvbSBcIi4uL3V0aWwvb2JqZWN0LW1ha2VyXCI7XHJcbmltcG9ydCB7IENyZWRpdENhcmRDb25maWcgfSBmcm9tIFwiLi4vbW9kZWxzL2NvbmZpZy9jcmVkaXQtY2FyZC1jb25maWdcIjtcclxuaW1wb3J0IHtnZXRDb25maWdPYmplY3R9IGZyb20gXCIuLi91dGlsL2NvbmZpZy1wcm92aWRlclwiXHJcbmltcG9ydCB7IEFubm90YXRpb25UeXBlcyB9IGZyb20gXCIuLi9jb3JlL3ZhbGlkYXRvci5zdGF0aWNcIjtcclxuaW1wb3J0IHsgRm9ybVByb3ZpZGVyIH0gZnJvbSAnLi4vdXRpbC9mb3JtLXByb3ZpZGVyJztcclxuaW1wb3J0IHsgY2hlY2tMZW5ndGggfSBmcm9tICcuLi91dGlsL2NoZWNrLWxlbmd0aCdcclxuaW1wb3J0IHsgY2FsY3VsYXRlIH0gZnJvbSAnLi4vYWxnb3JpdGhtL2x1aG4tYWxnb3JpdGhtJ1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGNyZWRpdENhcmRWYWxpZGF0b3IoY29uZmlnTW9kZWw6IENyZWRpdENhcmRDb25maWcpOiBWYWxpZGF0b3JGbiB7XHJcbiAgICBsZXQgY2FyZERpZ2l0czogeyBba2V5OiBzdHJpbmddOiBudW1iZXJbXSB9ID0ge1xyXG4gICAgICAgIEFtZXJpY2FuRXhwcmVzczogWzE1XSxcclxuICAgICAgICBEaW5lcnNDbHViOiBbMTQsIDE2LCAxOV0sXHJcbiAgICAgICAgRGlzY292ZXI6IFsxNiwgMTldLFxyXG4gICAgICAgIEpDQjogWzE2LCAxOV0sXHJcbiAgICAgICAgTWFlc3RybzogWzEyLCAxNiwgMTldLFxyXG4gICAgICAgIE1hc3RlckNhcmQ6IFsxNl0sXHJcbiAgICAgICAgVmlzYTogWzEzLCAxNiwgMTldXHJcbiAgICB9XHJcbiAgICBmdW5jdGlvbiB2YWxpZGF0ZShjcmVkaXRDYXJkTnVtYmVyOiBzdHJpbmcpIHtcclxuICAgICAgICB2YXIgZGlnaXQgPSBwYXJzZUludChjcmVkaXRDYXJkTnVtYmVyLnN1YnN0cmluZyhjcmVkaXRDYXJkTnVtYmVyLmxlbmd0aCAtIDEsIGNyZWRpdENhcmROdW1iZXIubGVuZ3RoKSk7XHJcbiAgICAgICAgcmV0dXJuIGNhbGN1bGF0ZShjcmVkaXRDYXJkTnVtYmVyLnN1YnN0cmluZygwLCBjcmVkaXRDYXJkTnVtYmVyLmxlbmd0aCAtIDEpKSA9PSBwYXJzZUludChTdHJpbmcoZGlnaXQpKSA/ICEwIDogITFcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBnZXRDYXJkUHJvdmlkZXJOYW1lKGNhcmROdW1iZXI6c3RyaW5nKSB7XHJcbiAgICAgICAgdmFyIGNhcmRQcm92aWRlck5hbWUgPSBcIlwiO1xyXG4gICAgICAgIHJldHVybiAvXig1MDE4fDUwMjB8NTAzOHw1NjEyfDU4OTN8NjMwNHw2NzU5fDY3NjF8Njc2Mnw2NzYzfDA2MDR8NjM5MClcXGQrJC8udGVzdChjYXJkTnVtYmVyKSA/IGNhcmRQcm92aWRlck5hbWUgPSBcIk1hZXN0cm9cIiA6IC9eNVsxLTVdLy50ZXN0KGNhcmROdW1iZXIpID8gY2FyZFByb3ZpZGVyTmFtZSA9IFwiTWFzdGVyQ2FyZFwiIDogL140Ly50ZXN0KGNhcmROdW1iZXIpID8gY2FyZFByb3ZpZGVyTmFtZSA9IFwiVmlzYVwiIDogL14zWzQ3XS8udGVzdChjYXJkTnVtYmVyKSA/IGNhcmRQcm92aWRlck5hbWUgPSBcIkFtZXJpY2FuRXhwcmVzc1wiIDogL14oPzoyMTMxfDE4MDB8MzUpLy50ZXN0KGNhcmROdW1iZXIpID8gY2FyZFByb3ZpZGVyTmFtZSA9IFwiSkNCXCIgOiAvXjMoPzowWzAtNV18WzY4XSkvLnRlc3QoY2FyZE51bWJlcikgPyBjYXJkUHJvdmlkZXJOYW1lID0gXCJEaW5lcnNDbHViXCIgOiAvXjYoPzowMTF8NSkvLnRlc3QoY2FyZE51bWJlcikgJiYgKGNhcmRQcm92aWRlck5hbWUgPSBcIkRpc2NvdmVyXCIpLCBjYXJkUHJvdmlkZXJOYW1lO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiAoY29udHJvbDogQWJzdHJhY3RDb250cm9sKTogeyBba2V5OiBzdHJpbmddOiBhbnkgfSB8IG51bGwgPT4ge1xyXG4gICAgICAgIGNvbnN0IGNvbnRyb2xWYWx1ZSA9IGNvbnRyb2wudmFsdWU7XHJcbiAgICAgICAgbGV0IGNvbmZpZyA9IGdldENvbmZpZ09iamVjdChjb25maWdNb2RlbCxjb250cm9sKTtcclxuICAgICAgICBjb25zdCBwYXJlbnRPYmplY3QgPSAoY29udHJvbC5wYXJlbnQpID8gY29udHJvbC5wYXJlbnQudmFsdWUgOiB1bmRlZmluZWQ7XHJcbiAgICAgICAgaWYgKEZvcm1Qcm92aWRlci5Qcm9jZXNzUnVsZShjb250cm9sLCBjb25maWcpKSB7XHJcbiAgICAgICAgICAgIGlmIChSZWdleFZhbGlkYXRvci5pc05vdEJsYW5rKGNvbnRyb2xWYWx1ZSkpIHtcclxuICAgICAgICAgICAgICAgIGxldCBpc1ZhbGlkID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICBsZXQgY2FyZFR5cGVzID0gY29uZmlnLmZpZWxkTmFtZSAmJiBwYXJlbnRPYmplY3RbY29uZmlnLmZpZWxkTmFtZV0gPyBbcGFyZW50T2JqZWN0W2NvbmZpZy5maWVsZE5hbWVdXSA6IGNvbmZpZy5jcmVkaXRDYXJkVHlwZXNcclxuICAgICAgICAgICAgICAgIGxldCBjYXJkVHlwZTogc3RyaW5nID0gJyc7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBjcmVkaXRDYXJkVHlwZSBvZiBjYXJkVHlwZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICBpc1ZhbGlkID0gY2hlY2tMZW5ndGgoY29udHJvbFZhbHVlLmxlbmd0aCwgY2FyZERpZ2l0c1tjcmVkaXRDYXJkVHlwZV0pICYmIGdldENhcmRQcm92aWRlck5hbWUoY29udHJvbFZhbHVlKSA9PSBjcmVkaXRDYXJkVHlwZSAmJiB2YWxpZGF0ZShjb250cm9sVmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhcmRUeXBlID0gY3JlZGl0Q2FyZFR5cGU7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzVmFsaWQpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKCFpc1ZhbGlkKVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBPYmplY3RNYWtlci50b0pzb24oQW5ub3RhdGlvblR5cGVzLmNyZWRpdENhcmQsIGNvbmZpZywgW2NvbnRyb2xWYWx1ZSwgY2FyZFR5cGVdKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBPYmplY3RNYWtlci5udWxsKCk7XHJcblxyXG4gICAgfVxyXG59XHJcbiJdfQ==